<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
    <title>收货地址</title>
    <!-- 引入样式文件 -->
    <link rel="stylesheet" href="https://oss.laisitech.com/04bb3a7d-8774-4441-9004-e77b0ae7e0aa.css">
    <link rel="stylesheet" href="../common/css/basic.css">
    <link rel="stylesheet" href="css/addressedit.css">
    <link rel="stylesheet" href="css/font/iconfont.css">
    <link rel="stylesheet" id="themeCssLink" href="../common/css/theme_white.css">
    <link rel="stylesheet" href="css/pointsLottery.css">


</head>
<!--  -->

<body>
    <div id="app" v-cloak>
        <div class="header">
            <van-nav-bar title="收货地址" @click-left="OnclickLeft" safe-area-inset-top fixed>
                <template #left>
						<span class="icon iconfont icon-fanhuianniu" style="font-size: 0.5rem;" />
					</template>
            </van-nav-bar>
        </div>
        <van-form @submit="onSubmit">
            <van-field v-model="addressInfo.receiver" maxlength="10" clearable :rules="[{ required: true, message: '收货人姓名1-10个字',trigger:'onSubmit' },{ pattern:/^.{1,10}$/,message: '收货人姓名1-10个字' }]" label="收货人" placeholder="收货人姓名"></van-field>
            <van-field v-model="addressInfo.phoneNumber" clearable type="tel" :rules="[{ pattern:/^(1\d{10})$/, required: true,message: '请输入正确的手机号',trigger:'onSubmit' }]" label="手机号" placeholder="收货人手机号"></van-field>
            <van-field readonly clickable right-icon="arrow" name="area" :rules="[{ required: true, message: '请选择所在地区',trigger:'onSubmit' }]" :value="addressInfo.wheel" label="所在地区" placeholder="点击选择省市区" @click="showArea = true"></van-field>
            <van-popup v-model="showArea" position="bottom">
                <van-area :area-list="areaList" @confirm="onConfirm" :value="addressInfo.postCode+''" @cancel="showArea = false"></van-area>
            </van-popup>
            <van-field v-model="addressInfo.address" maxlength="100" rows="1" type="textarea" autosize clearable :rules="[{ required: true, message: '详细地址1-100个字',trigger:'onSubmit' },{ pattern:/^.{1,100}$/,message: '详细地址1-100个字' }]" label="详细地址" placeholder="请填写详细地址"></van-field>
            <van-field v-model="addressInfo.buildingNo" rows="1" maxlength="100" type="textarea" autosize clearable :rules="[{ required: true, message: '门牌号1-100个字',trigger:'onSubmit' },{ pattern:/^.{1,100}$/,message: '门牌号1-100个字' }]" label="门牌号" placeholder="街道、门牌号等"></van-field>
            <div id="switch">
                <van-field name="switch" label="设为默认收货地址" input-align="right">
                    <template #input>
				    <van-switch v-model="addressInfo.formDefault" size="20" />
				  </template>
                </van-field>
            </div>
            <van-button round block type="info" class="submit" native-type="submit">
                保存并使用
            </van-button>
        </van-form>
        <van-button v-if="isedit" @click="confirmdel" round block type="info" class="submit2">
            删除收货地址
        </van-button>
    </div>
</body>
<script src="https://oss.laisitech.com/0bb12bf1-cb87-4d2c-a724-8a7c25b7ae04.js "></script>
<script src="https://oss.laisitech.com/6172e6c1-f460-40ac-97ba-31c8526f2e16.js"></script>
<script src="../common/js/network.js"></script>
<script src="js/area.js"></script>
<script src="js/tool.js"></script>
<script>
    new Vue({
        el: '#app',
        data() {
            return {
                isClick: false,
                isedit: getQueryString('isedit'),
                pid: getQueryString('id'),
                showArea: false,
                areaList: area,
                addressInfo: {
                    name: '',
                    phone: '',
                    address: '',
                    postCode: '',
                    detail: '',
                    isDefault: 0,
                    formDefault: false,
                    wheel: ''
                }
            }
        },
        filters: {},
        mounted() {},
        created() {
            if (this.isedit) this.queryByid();
        },
        methods: {
            queryByid() {
                var _self = this;
                ajax({
                    type: "get",
                    url: "activity/postAddressInfo/queryAddressInfo",
                    data: {
                        id: _self.pid
                    },
                    success: function(res) {
                        if (res.code == 0) {
                            res.data.formDefault = res.data.isDefault == 1 ? true : false;
                            res.data.wheel = res.data.province + res.data.city + res.data.county;
                            _self.addressInfo = res.data;
                            // _self.areaList = area;
                        } else {
                            _self.$toast(res.msg);
                        }
                    },
                    error: function() {
                        console.log("error")
                    }
                })
            },
            OnclickLeft() {
                window.history.back(-1);
            },
            onConfirm(obj) {
                console.log(obj)
                this.addressInfo.province = obj[0].name;
                this.addressInfo.city = obj[1].name;
                this.addressInfo.county = obj[2].name;
                this.addressInfo.wheel = obj[0].name + obj[1].name + obj[2].name;
                this.addressInfo.postCode = obj[2].code;
                this.showArea = false;
            },
            onSubmit(values) {
                console.log('submit', this.addressInfo);
                if (this.isClick) return;
                this.isClick = true;
                if (this.addressInfo.formDefault) this.addressInfo.isDefault = 1
                else this.addressInfo.isDefault = 0;
                this.addNew()
            },
            addNew() { //添加新地址
                var _self = this;
                ajax({
                    type: "post",
                    url: _self.isedit ? "activity/postAddressInfo/update" : "activity/postAddressInfo/add",
                    data: _self.addressInfo,
                    success: function(res) {
                        if (res.code == 0) {
                            localStorage.setItem("addressEdit", res.data.id);
                            localStorage.setItem("needreload", 1);
                            _self.$toast("操作成功");
                            setTimeout(function() {
                                _self.OnclickLeft();
                            }, 1500)
                        } else {
                            _self.isClick = false;
                            _self.$toast(res.msg);
                        }
                    },
                    error: function() {
                        _self.isClick = false;
                        console.log("error")
                    }
                })
            },
            confirmdel() { //确定删除地址
                if (this.isClick) return;
                this.$dialog.confirm({
                        title: '',
                        message: '确定删除该地址吗',
                    })
                    .then(() => {
                        this.deladd();
                        // on confirm
                    })
                    .catch(() => {
                        // on cancel
                    });
            },
            deladd() { //删除地址
                var _self = this;
                ajax({
                    type: "get",
                    url: "activity/postAddressInfo/delete",
                    data: {
                        id: _self.pid
                    },
                    success: function(res) {
                        if (res.code == 0) {
                            _self.$toast("删除成功！");
                            localStorage.setItem("needreload", 1);
                            setTimeout(function() {
                                _self.OnclickLeft();
                            }, 1500)
                        } else {
                            _self.$toast(res.msg);
                        }
                    },
                    error: function() {
                        console.log("error")
                    }
                })
            }


        }
    })
</script>

</html>