<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
    <title>确认订单</title>
    <!-- 引入样式文件 -->
    <link rel="stylesheet" href="https://oss.laisitech.com/ccd1029d-8dd1-442a-94a7-5205ee2ff9f5.css">
    <link rel="stylesheet" href="../common/css/basic.css">
    <link rel="stylesheet" href="css/iconfont.css">
    <link rel="stylesheet" href="css/ordersubmit.css">
    <link rel="stylesheet" href="css/font/iconfont.css">
    <link rel="stylesheet" id="themeCssLink" href="../common/css/theme_black.css">
    <link rel="stylesheet" href="css/pointsLottery.css">
    <style type="text/css">
        .van-address-item__address {
            display: -webkit-box;
            overflow: hidden;
            text-overflow: ellipsis;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .list_ul {
            padding: .4rem .3rem;
        }
        
        .van-address-list .van-address-item .van-cell {
            background-color: transparent;
        }
        
        .van-icon-arrow {
            color: var(--textColor2)
        }
        
        .van-popup__close-icon {
            color: var(--textColor)
        }
    </style>

</head>

<body>
    <div id="app" v-cloak>
        <div class="header">
            <van-nav-bar title="确认订单" @click-left="OnclickLeft" safe-area-inset-top fixed>
                <template #left>
						<span class="icon iconfont icon-fanhuianniu" style="font-size: 0.5rem;" />
					</template>
            </van-nav-bar>
        </div>
        <van-loading type="spinner" vertical v-show="submitFlag"></van-loading>
        <!-- 包邮券栏 -->
        <van-action-sheet v-model="postcouponshow" :actions="actions" cancel-text="取消" close-on-click-action @cancel="onCancel" @select="onSelect"></van-action-sheet>
        <!-- 地址栏 -->
        <div id="addressBox" v-if="addresslist.length>0" class="" @click="addressshow = true">
            <div class="province van-ellipsis">{{chooseAdd.province + chooseAdd.city +chooseAdd.county}}<span v-if="chooseAdd.isDefault==1" class="van-tag van-tag--round van-tag--danger van-address-item__tag">默认</span></div>
            <div class="ub ub-ac ub-pj">
                <div class="detail van-ellipsis">{{chooseAdd.address + chooseAdd.buildingNo||""}}</div>
                <van-icon name="arrow" size="18" />
            </div>
            <div class="name van-ellipsis">{{chooseAdd.receiver}} {{chooseAdd.phoneNumber}}</div>
        </div>
        <div v-else id="addressBox" @click="goaddress()">
            <div class="province van-ellipsis">暂无收货地址</div>
            <div class="ub ub-ac ub-pj">
                <div class="detail van-ellipsis">新建收货地址</div>
                <van-icon name="arrow" size="18" />
            </div>
            <div class="name van-ellipsis">&nbsp;</div>
        </div>
        <!-- 地址栏弹框 -->
        <van-popup v-model="addressshow" closeable position="bottom" :style="{ height:addresslist.length>=2? '48%':'39%',overflow:'hidden' }" id="addressChoose">
            <div class="title">选择收货地址</div>
            <van-address-list v-model="chooseAdd.id" :list="addresslist" @select="selectAdd" default-tag-text="默认" @add="goaddress()" @edit="onaddressEdit" />
        </van-popup>
        <!-- 奖品栏 -->
        <div id="priceBox">
            <ul class="list_ul">
                <li class="ub ub-pj ub-ac" v-for="item in priceinfo2">
                    <div class="ub ub-ac">
                        <div class="imgbox">
                            <img :src="item.logo" alt="">
                        </div>
                        <div>
                            <div class="title van-multi-ellipsis--l2">{{item.name}}</div>
                        </div>
                    </div>
                    <div class="task_finish">
                        X{{item.count}}
                    </div>
                </li>
            </ul>
        </div>
        <!-- 运费 -->
        <div id="freight" class="ub ub-ac ub-pj">
            <div class="title">运费：￥12.00</div>
            <div class="ub ub-ac">
                <div :class="{detail:true,}">{{haspostcoupon?'使用包邮券':'暂无包邮券'}}</div>
                <!-- <van-icon name="arrow" color="#999" size="18"></van-icon> -->
            </div>

        </div>
        <!-- 提交栏 -->
        <div id="submitbox" class="ub ub-ac ub-pj">
            <div class="moneybox">
                应付：<span>￥</span><span>{{usepostcoupon?'0.00':"12.00"}}</span>
            </div>
            <div :class="{task_unfinish:true,task_finish:!usepostcoupon||addresslist.length==0}" @click="submitfirst(!usepostcoupon||addresslist.length==0)">
                提交订单
            </div>
        </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/vant@2.12/lib/vant.min.js"></script>
<script src="../common/js/network.js"></script>
<script src="js/tool.js"></script>
<script>
    window.addEventListener('pageshow', function(event) {
        console.log("PageShow Event  " + event.persisted);
        console.log(event)
        if (localStorage.getItem('needreload')) {
            window.reflashFuc();
            localStorage.removeItem('needreload');
        }
    })
    new Vue({
        el: '#app',
        data() {
            return {
                actions: [{
                    name: "使用包邮券"
                }, {
                    name: "不使用"
                }],
                postcouponshow: false, //包邮券显示
                usepostcoupon: true, //是否使用包邮券
                haspostcoupon: true, //是否有包邮券
                addressshow: false,
                addresslist: [],
                chooseAdd: {},
                priceinfo: JSON.parse(localStorage.getItem("priceinfo")).choosedprice,
                priceinfoList: [],
                submitForm: {
                    bagAwardIds: JSON.parse(localStorage.getItem("priceinfo")).bagAwardIds,
                    addressId: null,
                    postingCoupon: JSON.parse(localStorage.getItem("priceinfo")).postingCoupon
                },
                submitFlag: false,
            }
        },
        filters: {},
        mounted() {
            window.reflashFuc = this.reflashFuc;
        },
        created() {
            let arr = [];
            this.priceinfo.forEach(item => {
                let obj = {};
                let jsonstr = item.split(',');
                obj.name = jsonstr[0];
                obj.count = jsonstr[1];
                obj.logo = jsonstr[2];
                obj.sortIndex = jsonstr[3];
                arr.push(obj);
            });
            this.priceinfo2 = arr.sort(compare('sortIndex'));
            this.getAddress();
            this.getAddressDefalut();
        },
        methods: {
            reflashFuc() {
                this.getAddress();
                this.getAddressDefalut();
            },
            getAddressDefalut() { //获取默认地址
                if (localStorage.getItem("addressEdit")) {
                    return;
                }
                var _self = this;
                ajax({
                    type: "get",
                    url: "activity/postAddressInfo/queryIsDefaultAddressInfo",
                    data: {
                        dsd: new Date().getTime()
                    },
                    success: function(res) {
                        if (res.code == 0) {
                            _self.chooseAdd = res.data;
                            _self.chooseAdd.name = _self.chooseAdd.receiver;
                            _self.chooseAdd.tel = _self.chooseAdd.phoneNumber;
                            // _self.chooseAdd.address = _self.chooseAdd.address + _self.chooseAdd.buildingNo;
                        } else {
                            _self.$toast(res.msg);
                        }
                    },
                    error: function() {
                        console.log("error")
                    }
                })
            },
            getAddress() { //获取地址
                var _self = this;
                ajax({
                    type: "get",
                    url: "activity/postAddressInfo/queryAllAddressInfo",
                    data: {
                        dsd: new Date().getTime(),
                        pageSize: 30
                    },
                    success: function(res) {
                        if (res.code == 0) {
                            _self.addresslist = res.data;
                            if (_self.addresslist.length == 0) {
                                _self.addressshow = false
                            }
                            var addressEdit = localStorage.getItem("addressEdit");
                            _self.addresslist.forEach((item, index) => {
                                item.name = item.receiver;
                                item.tel = item.phoneNumber;
                                // item.address = item.address + item.buildingNo;
                                if (addressEdit == item.id) {
                                    _self.chooseAdd = item;
                                    localStorage.removeItem("addressEdit");
                                }
                            })
                        } else {
                            _self.$toast(res.msg);
                        }
                    },
                    error: function() {
                        console.log("error")
                    }
                })
            },
            OnclickLeft() {
                window.history.back(-1);
                // window.location.href = document.referrer
            },
            onSelect(action, index) { //点击选择。。。的菜单
            },
            onCancel() { //关闭。。。的弹框
                this.postcouponshow = false;
            },
            submitfirst(cansubmit) {
                if (cansubmit) return;
                if (this.submitFlag) return;
                this.submitFlag = true;
                this.submitForm.addressId = this.chooseAdd.id;
                var _self = this;
                ajax({
                    type: "post",
                    url: "activity/UserBag/exchange",
                    data: _self.submitForm,
                    success: function(res) {
                        if (res.code == 0) {
                            localStorage.setItem('ordersuccess', 2);
                            window.location.replace("orderresult.html?isSuccess=1&fromwhere=1");
                        } else {
                            _self.submitFlag = false;
                            window.location.href = "orderresult.html?isSuccess=2&fromwhere=1";
                            _self.$toast(res.msg);
                        }
                    },
                    error: function() {
                        window.location.href = "orderresult.html?isSuccess=2&fromwhere=1";
                        _self.submitFlag = false;
                        console.log("error")
                    }
                })
            },
            selectAdd(item, index) { //xuanzhongdizhi
                this.chooseAdd = item;
            },
            onaddressEdit(item, index) {
                console.log('编辑地址:' + index);
                this.goaddress(true, item.id);
            },
            goaddress(isedit, id) { //跳转前往编辑地址
                if (isedit) window.location.href = 'addressedit.html?isedit=1&id=' + id
                else window.location.href = 'addressedit.html'
            },

        }
    })
</script>

</html>