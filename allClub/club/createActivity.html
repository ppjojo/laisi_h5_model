<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
		<title>创建活动(1/2)</title>
		<!-- 引入样式文件 -->
		<link rel="stylesheet" href="https://oss.laisitech.com/04bb3a7d-8774-4441-9004-e77b0ae7e0aa.css">
		<link rel="stylesheet" href="css/clubCreateCompetition.css">
		<script type="text/javascript">
			document.documentElement.style.fontSize = document.documentElement.clientWidth / 7.5 + 'px';
		</script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.6/cropper.min.js"></script>
		<script src="js/exif.js"></script>
		<script src="js/upload.js"></script>
		<style type="text/css">
			.cropper-container {
				display: none;
				height: 0;
			}

			.chosed .van-cell__value {
				color: #1F1F1F;
			}

			.club-input {
				min-height: 1.5rem;
			}
		</style>
	</head>
	<body>
		<div id="app" v-cloak>
			<div>
				<div >
					<div class="laberDiv">
						活动名称
					</div>
					<div style="padding:0 0.2rem 0.2rem 0.2rem;border-bottom: 1px solid #f8f8f8;">
						<van-field v-model="submitform.title" :input="titleChange()" class="club-input" style="min-height:1.2rem;" rows="2"
						 autosize type="textarea" maxlength="16" placeholder="请输入活动名称" show-word-limit />
					</div>
				</div>
				<div @click="startTimeShow = true" style="border-bottom: 1px solid #f8f8f8;">
					<van-cell title="开始时间" :class="form.start.indexOf('请选择')!=-1?'':'chosed'" is-link :value="form.start"></van-cell>
				</div>
				<div @click="endTimeShow = true">
					<van-cell title="结束时间" :class="form.end.indexOf('请选择')!=-1?'':'chosed'" is-link :value="form.end"></van-cell>
				</div>

				<van-button round class="submit" block :color="!submitform.startTime||!submitform.endTime||!submitform.title?bgcgrey:bgc"
				 @click="submitFormData">下一步</van-button>

				<van-popup v-model="startTimeShow" position="bottom">
					<van-picker show-toolbar :columns="startTimeColumns" @cancel="startTimeShow = false" @confirm="onstartTimeConfirm"
					 @change="onstartTimeChange" />
				</van-popup>

				<van-popup v-model="endTimeShow" position="bottom">
					<van-picker show-toolbar :columns="endTimeColumns" @cancel="endTimeShow = false" @confirm="onendTimeConfirm"
					 @change="onendTimeChange" />
				</van-popup>
				<van-overlay :show="overlayShow" @click="show = false" style="align-items: center;display: flex;justify-content: center;">
					<van-loading size="0.7rem" color="#fff" vertical>
						<p style="color:#fff;font-size:0.24rem">正在创建...</p>
					</van-loading>
				</van-overlay>
			</div>
		</div>
	</body>
	<script src="https://oss.laisitech.com/0bb12bf1-cb87-4d2c-a724-8a7c25b7ae04.js "></script>
<script src="https://oss.laisitech.com/6172e6c1-f460-40ac-97ba-31c8526f2e16.js"></script>
	<script src="js/DateTime.js"></script>

	<script src="../../common/js/network.js"></script>
	<script>
		var handler = function(e) {
			e.preventDefault();
		}
		new Vue({
			el: '#app',
			data() {
				return {
					bgc: "linear-gradient(to right, #FF6A88, #FF5136 )",
					bgcgrey: '#999',
					isClick: false,
					activeNames: 0,
					matchName: '',
					clubId: "",
					isSubmit: false,
					jlinput: false,
					overlayShow: false,

					startTimeColumns: [],
					startTimeShow: false,
					startTime: [],

					endTimeColumns: [],
					endTimeShow: false,

					fileList: [],


					form: {
						mc: "",
						start: "请选择开始时间",
						end: "请选择结束时间",

					},
					submitform: {
						"startTime": "",
						"endTime": "",
						"title": "",
						"info": ""
					}

				};
			},
			watch: {
				startTimeShow: function(val) {
					if (val) {
						document.getElementsByTagName('body')[0].addEventListener('touchmove', this.handler, {
							passive: false
						});
					} else {
						document.getElementsByTagName('body')[0].removeEventListener('touchmove', this.handler, {
							passive: false
						});
					}
				},
				endTimeShow: function(val) {
					if (val) {
						document.getElementsByTagName('body')[0].addEventListener('touchmove', this.handler, {
							passive: false
						});
					} else {
						document.getElementsByTagName('body')[0].removeEventListener('touchmove', this.handler, {
							passive: false
						});
					}
				}
			},
			created() {
				this.clubId = getQueryString("id") || 10000111;
				if (JSON.parse(localStorage.getItem('activityForm'))) {
					this.submitform = JSON.parse(localStorage.getItem('activityForm'));
					var timeArray = DateTime.needYearOrNot2(this.submitform.startTime, this.submitform.endTime);
					this.form.start = timeArray[0];
					this.form.end = timeArray[1];
					this.initEndTime(DateTime.sjc2time('ymdhms', this.submitform.startTime + 3600000));
				}
				var startTime = DateTime.initStart(2);
				this.startTimeColumns = [{
						values: Object.keys(startTime),
					},
					{
						values: [],
					}
				]
				this.startTime = startTime;
				//先初始化结束时间
				this.initEndTime();

			},
			methods: {
				//开始时间的回调
				onstartTimeConfirm(value, index) {
					if (value[0] == "立即开始") {
						var nowTime = DateTime.timeStamp2String('ymdhm');
						this.form.start = DateTime.timeStamp2String('mdhm');

						this.submitform.startTime = DateTime.getSjc(nowTime);
						this.initEndTime(DateTime.sjc2time('ymdhms', DateTime.getSjc(nowTime) + 3600000));
					} else {
						this.form.start = DateTime.sjc2time('mdhm2', DateTime.getSjc(value[0] + " " + value[1].text))

						this.submitform.startTime = DateTime.getSjc(value[0] + " " + value[1].text);
						this.initEndTime(value[0] + " " + value[1].text);
					}
					this.form.end = "";
					this.submitform.endTime = "";
					this.startTimeShow = false;

				},
				//开始时间的改变
				onstartTimeChange(picker, value, index) {
					picker.setColumnValues(1, this.startTime[value[0]]);
				},
				//初始化结束时间
				initEndTime(time) {
					var num = 5;
					var endTime = DateTime.initEnd(time, 2);
					num = 1
					if (time) {
						var starth = DateTime.timeStamp2String("h", DateTime.getTime(time))
						var endh = Number(starth) + num;
					} else {
						var starth = DateTime.getHours()
						var endh = Number(starth) + num;
					}

					if (endh > 23) {
						this.endTimeColumns = [{
								values: Object.keys(endTime),
							},
							{
								values: endTime[DateTime.getDateByNum(1, time)],
							}
						]
					} else {
						this.endTimeColumns = [{
								values: Object.keys(endTime),
							},
							{
								values: endTime[DateTime.getDateByNum(0, time)],
							}
						]
					}

					this.endTime = endTime;
				},
				//结束时间的回调
				onendTimeConfirm(value, index) {
					var _self = this;
					this.form.end = DateTime.sjc2time('mdhm2', DateTime.getSjc(value[0] + " " + value[1].text))
					this.submitform.endTime = DateTime.getSjc(value[0] + " " + value[1].text);
					if (this.submitform.startTime) {
						var timeArray = DateTime.needYearOrNot2(this.submitform.startTime, this.submitform.endTime);
						this.form.start = timeArray[0];
						this.form.end = timeArray[1];
					}
					this.endTimeShow = false;
					setTimeout(function() {
						_self.activeNames = 0;
					}, 300)
				},
				//结束时间的改变
				onendTimeChange(picker, value, index) {
					//this.form.end = value[0] + " " + value[1].text;
					picker.setColumnValues(1, this.endTime[value[0]]);
				},

				//文件选择之后的回调压缩裁剪处理
				afterRead(file) {

				},
				uploadPicReady(file) {
					console.log("原始的文件")
					console.log(file.file)
					var _self = this;
					//_self.uploadPic(file.file)
					UpladFile({
						file: file.file
					}, function(item) {
						_self.fileList[0] = item;
						console.log("压缩后的文件")
						console.log(item.file)
						_self.uploadPic(item.file)
					})

				},
				//上传图片
				uploadPic(file) {
					console.log("准备上传的文件")
					console.log(file)
					var _self = this;
					_self.overlayShow = true;
					var formdata = new FormData();
					formdata.append("file", file);

					ajax({
						type: "post",
						url: "oss/upload/file",
						contentType: "multipart/form-data",
						data: formdata,
						success: function(res) {
							if (res.code == 0) {
								_self.submitform.picUrl = res.data.url;
								_self.submitFormDataSecond();
							} else {
								_self.overlayShow = false;
								_self.$toast(res.msg);
							}
						},
						error: function() {
							console.log("error")
						}
					})
				},
				//提交表单数据
				submitFormData() {
					var _self = this;
					if (_self.isClick) {
						return;
					}
					if (!this.submitform.startTime || !this.submitform.endTime || !this.submitform.title) {
						return;
					}
					this.checkStr(this.submitform.title, function() {
						_self.isClick = true
						_self.isSubmit = true;
						_self.submitform.promoterId = JSON.parse(localStorage.getItem("appInfo")).userId;
						_self.submitform.clubId = _self.clubId;
						localStorage.setItem('activityForm', JSON.stringify(_self.submitform));
						_self.isClick = false;
						window.location.href = 'createActivity2.html';
					})
					return;
					for (var key in this.submitform) {
						if (this.submitform[key] === "") {
							_self.isClick = false;
							return;
						}
					}
					if (_self.fileList.length == 0) {
						_self.isClick = false;
						return;
					};
					_self.uploadPicReady(_self.fileList[0]);
				},
				submitFormDataSecond() {
					var _self = this;
					ajax({
						type: "post",
						url: "contentSecurity/aliyun/imageScan?userId=" + JSON.parse(localStorage.getItem("appInfo")).userId,
						data: {
							content: this.submitform.picUrl
						},
						success: function(res) {
							if (res.code == 0) {
								ajax({
									type: "post",
									url: "club/activity/create",
									data: _self.submitform,
									success: function(res) {
										if (res.code == 0) {
											_self.overlayShow = false;
											_self.$toast("活动创建成功！");
											_self.createNotice(res.data[0].id);
										} else {
											_self.isClick = false;
											_self.overlayShow = false;
											_self.$toast(res.msg);
										}
									},
									error: function() {
										_self.isClick = false;
										console.log("error")
									}
								})
							} else {
								_self.isClick = false;
								_self.overlayShow = false;
								_self.fileList = []
								_self.$toast("图片审核未通过，请重新上传！");
							}
						},
						error: function() {
							_self.isClick = false;
							_self.overlayShow = false;
							_self.fileList = []
							console.log("error")
						}
					})
				},
				createNotice(activityId) {
					var _self = this;
					ajax({
						type: "post",
						url: "club/saveClubNotice",
						data: {
							title: "有新的活动," + _self.submitform.title,
							content: _self.submitform.info,
							clubId: _self.clubId,
							type: "02",
							relatedId: activityId
						},
						success: function(res) {
							if (res.code == 0) {
								_self.gotoDetail(activityId);
							} else {
								_self.$toast(res.msg);
							}
						},
						error: function() {
							console.log("error")
						}
					})
				},
				gotoDetail(activityId) {
					var _self = this;
					if (/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)) { //判断iPhone|iPad|iPod|iOS
						try {
							window.webkit.messageHandlers.lstNative.postMessage({
								'method': 'clubToActivityDetail',
								"activityId": activityId,
							})
						} catch (err) {
							console.log('window.webkit.messageHandlers 回传Id failed')
						}

					} else if (/(Android)/i.test(navigator.userAgent)) { //判断Android
						var str = 'activityId=' + activityId;
						window.android.clubToActivityDetail(str);
					}
					window.location.href = "activityDetail.html?id=" + activityId + '&clubId=' + _self.clubId + '&isAttend=1'

				},
				checkStr(param, cb) {
					var that = this;
					ajax({
						type: "post",
						url: "contentSecurity/aliyun/textScan",
						data: {
							content: param
						},
						success: function(res) {
							if (res.code == 0) {
								cb()
							} else if (res.code == 4001) {
								that.$toast("输入的活动名称不合法!");
								that.isClick = false;
							}
						},
						error: function() {
							console.log("error")
						}
					})
				},
				titleChange() {
					if (this.submitform.title) this.submitform.title = this.submitform.title.replace(
						/[^\u4E00-\u9FA5|\d|\a-zA-Z|\r\n\s,.?!，。#￥$%\`~^？！@…—&$=()\-+\/*{}【】\\（）[\]]|\s/g, '')
				},
				contentChange() {
					if (this.submitform.info) this.submitform.info = this.submitform.info.replace(
						/[^\u4E00-\u9FA5|\d|\a-zA-Z|\r\n\s,.?!，。#￥$%\`~^？！@…—&$=()\-+\/*{}【】\\（）[\]]|\s/g, '')
				}

			}
		})
	</script>
</html>
