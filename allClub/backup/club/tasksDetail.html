<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
		<title>任务详情</title>
		<link rel="stylesheet" href="../../common/css/vant-rem.css">
		<link rel="stylesheet" href="css/tasksDetail.css">
		<script type="text/javascript">
			document.documentElement.style.fontSize = document.documentElement.clientWidth / 7.5 + 'px';
		</script>
		<style>
			.memberDetailBox{
				padding-bottom: .92rem;
			}
		</style>
	</head>
	<body>
		<div id="app" v-cloak>
			<!-- <div class="header">
				<van-nav-bar title="" @click-left="OnclickLeft" v-if="ifios" left-arrow>
				</van-nav-bar>
			</div> -->
			<div class="bgf8">
				<div>
					<van-notice-bar :scrollable="false" :text="taskItem.taskNotice.title||'暂无任务通知!'" @click="noticeDetail(taskItem.taskNotice.taskNoticeId)"  mode="link" left-icon="img/iconNotice.png" />
				</div>
				<div class="deatilBox">
					<van-row>
						<van-col span="4" class="laberTitle">任务名称<i></i></van-col>
						<van-col span="1" class="laberTitle">：</van-col>
						<van-col span="19" class="laberContent">
							{{taskItem.task.name}}
						</van-col>
					</van-row>
					<van-row>
						<van-col span="4" class="laberTitle">任务项目<i></i></van-col>
						<van-col span="1" class="laberTitle">：</van-col>
						<van-col span="19" class="laberContent">
							{{taskItem.task.label=="00"?"跳绳":""}}
						</van-col>
					</van-row>
					<van-row>
						<van-col span="4" class="laberTitle">任务周期<i></i></van-col>
						<van-col span="1" class="laberTitle">：</van-col>
						<van-col span="19" class="laberContent">
							{{taskItem.task.period=="00"?"每天":taskItem.task.period=="01"?"每周":taskItem.task.period=="02"?"每月":taskItem.task.period=="03"?"单次任务":""}}
							<span v-if="taskItem.task.period=='03'"></span>	
						</van-col>
					</van-row>
					<van-row>
						<van-col span="4" class="laberTitle">任务目标<i></i></van-col>
						<van-col span="1" class="laberTitle">：</van-col>
						<van-col span="19" class="laberContent">
							{{taskItem.task.target}}
						</van-col>
					</van-row>
					<van-row>
						<van-col span="4" class="laberTitle">任务说明<i></i></van-col>
						<van-col span="1" class="laberTitle">：</van-col>
						<van-col span="19" class="laberContent">
							{{taskItem.task.introduce}}
						</van-col>
					</van-row>
				</div>
				<div class="memberList" v-if="taskItem.joinTaskMember&&taskItem.joinTaskMember.length>0">
					<div class="memberTitle">{{taskItem.taskStausDesc=='报名'||taskItem.taskStausDesc=='接受任务'?"成员":"参与成员"}}</div>
					<div>
						<van-row  @click="memberList">
							<van-col span="15" class="peopeleList">
								<div class="peopeleBox"   v-for="(item ,index) in taskItem.joinTaskMember" v-if="index<4" :style="{'left':index*0.4+'rem'}">
									<img :src="item.headPictureUrl " >
								</div>
							</van-col>
							<van-col span="7" class="finishNumber">{{taskItem.doneMemberList.length}}人完成任务</van-col>
							<van-col span="2" class="finishIcon" >
								<van-icon name="arrow" />
							</van-col>
						</van-row>
					</div>
				</div>
				<div class="memberDetailList" style="margin-bottom:1rem;">
					<div>
						<van-row>
							<van-col span="12" class="schedule">
								进度
							</van-col>
							<van-col span="12" class="finishStatus">今日完成率 {{taskItem.donePercent||0}}%</van-col>
						</van-row>
					</div>
					<div class="memberDetailBox" v-if="taskItem.doneMemberList&&taskItem.doneMemberList.length>0">
						<van-row v-for="item in taskItem.doneMemberList">
							<van-col span="3" class="" @click="Interaction.visitPersonalHomepage(item.memberId)"><div class="detail_headpic"   :style="{'background-image': 'url(' + item.headPictureUrl + ')'}"></div></van-col>
							<van-col span="6" class="personalName" @click="Interaction.visitPersonalHomepage(item.memberId)">{{ item.nickname| ellipsis }}</van-col>
							<van-col span="15" v-if="taskItem.task.period=='03'"  class="personalName " style="text-align:right">已完成</van-col>
							<van-col span="7" v-if="taskItem.task.period!='03'"  class="personalName " >已完成</van-col>
							<van-col span="8" v-if="taskItem.task.period!='03'" class="finishTimes">累计完成{{item.times||0}}次</van-col>
						</van-row>
						
					</div>
					<div class="noPeople-div" v-else>
						<img class="noPeoplePic" src="./img/noPeople.png"/>
						<p class="noPeopleP">任务竟然没有人参与</p>	
					</div>
				</div>
				<div class="btn_box">
					<van-button class="creatMatch " size="large" v-if="taskItem.taskStausDesc=='报名'" @click="signUp()">报名</van-button>
					<van-button class="creatMatch " size="large" v-else-if="taskItem.taskStausDesc=='接受任务'" @click="signUp()">接受任务</van-button>
					<van-button class="creatMatch " size="large" v-else-if="taskItem.taskStausDesc=='完成任务'" @click="gotoSkipReady">完成任务</van-button>
					<van-button class="creatMatch creatMatch2" size="large" v-else-if="taskItem.taskStausDesc=='任务已完成'">任务已完成</van-button>
					<van-button class="creatMatch creatMatch2" size="large" v-else-if="taskItem.taskStausDesc=='任务已结束'">任务已结束</van-button>
					<van-button class="creatMatch creatMatch2" size="large" v-else-if="taskItem.taskStausDesc=='任务未开始'">任务未开始</van-button>
				</div>
				<van-action-sheet v-model="macShow" :round=false description="请选择您的跳绳设备" cancel-text="取消">
					<div class="button_box">
						<button class="van-action-sheet__item van-hairline--top" v-for="item in macItem" @click="macSelect(item)">
							<span class="van-action-sheet__name active" v-if="item.bind">{{item.macName}} <img class="blueboothPic" src="./img/bluebooth.png" /></span>
							<span class="van-action-sheet__name" v-else>{{item.macName}}</span>
						</button>
					</div>
				</van-action-sheet>
			</div>
		</div>
	</body>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vant@2.9/lib/vant.min.js"></script>
	 
	<script src="../../common/js/network.js"></script>
	<script type="text/javascript">
		new Vue({
			el: '#app',
			data(){
				return{
					taskId:"",
					clubId:"",
					macShow: false,
					ifios:false,
					macItem: [
					
					],
					mac: "",
					macName: "",
					deviceModel:"",
					taskItem:{
						taskNotice:{},
						doneMemberList:[],
						task:{},
						joinTaskMember:[]
					}
				}
			},
			filters: {
				ellipsis(value) {
					if (!value) return '';
					if (value.length > 4) {
						return value.slice(0, 4) + '...';
					}
					return value;
				}
			},
			mounted() {
				window.taskDetail = this.initDetail;
				window.initCompetitionDetail = this.initDetail;
				window.getConnectedMac = this.getConnectedMac
			},
			created() {
				this.ifios = isIOS;
				this.taskId=getQueryString("id")||"";
				this.clubId=getQueryString("clubId")||"";
				this.taskDetail();
				this.getMac();
			},
			methods:{
				OnclickLeft(){
					Interaction.closePage();
				},
				memberList(){
					var str = "h5/h5V2/allClub/club/taskMemberList.html?id=" + this.taskId;
					if (isIOS) {
						var allstr = "/" + str
						Interaction.pushToNextVC(allstr)
					} else {
						window.location.href="taskMemberList.html?id="+this.taskId
					}
				},
				initDetail(){
					this.taskDetail();
					localStorage.setItem("dataChange","tabDetailChange");                                                               
				},
				taskDetail(){
					var _self=this;
					ajax({
						type: "post",
						url: "club/taskDetail",
						data: {
							taskId:this.taskId,
							clubId:this.clubId,
							memberId:JSON.parse(localStorage.getItem("appInfo")).userId
						},
						success: function(res) {
							if (res.code == 0) {
								_self.taskItem=res.data;
							} else {
								_self.$toast(res.msg);
							}
						},
						error: function() {
							console.log("error")
						}
					})
				},
				//报名
				signUp(){
					var _self=this;
					ajax({
						type: "post",
						url: "club/signUp",
						data: {
							clubId:this.clubId,
							taskId:this.taskId,
							memberId:JSON.parse(localStorage.getItem("appInfo")).userId,
						},
						success: function(res) {
							if (res.code == 0) {
								_self.$toast("报名成功!");
								_self.initDetail();
							} else {
								_self.$toast(res.msg);
							}
						},
						error: function() {
							_self.isClick = false;
							console.log("error")
						}
					})
				},
				//查看通知详情 type=1是任务通知
				noticeDetail(id){
					if(!id)return;
					window.location.href="../clubList_Detail/noticeDetail.html?type=1&id="+id;
				},
				//mac地址的选取并进入跳绳页面
				macSelect(item) {
					this.mac = item.mac;
					this.macName = item.name;
					this.deviceModel=item.deviceModel;
					if (this.mac) {
						this.gotoSkip2();
					}
					this.macShow = false;
				},
				//获取mac地址
				getMac() {
					var _self = this;
					_self.macItem = [];
					ajax({
						type: "get",
						url: "device/get/bound/device",
						data: {},
						success: function(res) {
							if (res.code == 0) {
								var items = [];
								for (var i = 0; i < res.data.length; i++) {
									if (res.data[i].deviceType == "skipping") {
										var item = {
											macName: res.data[i].deviceNickName,
											mac: res.data[i].btMac,
											deviceModel: res.data[i].deviceModel,
										}
										items.push(item);
									}
								}
								_self.macItem = items;
							} else {
								_self.macItem = [];
							}
						},
						error: function() {
							console.log("error")
						}
					})
				},
				
				//完成任务前需要激活任务
				activeTask(){
					var _self=this;
					ajax({
						type: "post",
						url: "club/activeTask",
						data: {
							clubId:_self.clubId,
							taskId:_self.taskId,
							memberId:JSON.parse(localStorage.getItem("appInfo")).userId,
						},
						success: function(res) {
							if (res.code == 0) {
								_self.initDetail();
							} else {
								_self.$toast(res.msg);
							}
						},
						error: function() {
							console.log("error")
						}
					})
				},
				gotoSkipReady() {
					Interaction.gotoGetConnectedMac()
					this.activeTask();
				},
				//获取到绑定的蓝牙地址后回调处理
				getConnectedMac(list) {
					console.log("连接中的mac地址的回调1")
					console.log(list)
					var that = this;
					var linkList = JSON.parse(list);
					var macBind = linkList.skipping||linkList.t18mac || linkList.t20mac||linkList.nkt30l||linkList.lst30l
					var bindIndex = 0;
					for (var i = 0; i < that.macItem.length; i++) {
						if (macBind) {
							if (that.macItem[i].mac.toLowerCase() == macBind.toLowerCase()) {
								that.macItem[i].bind = true;
								bindIndex = i;
							}
						}
					}
					if (macBind && that.macItem.length > 0) {
						that.macItem.unshift(that.macItem[bindIndex]);
						that.macItem.splice(bindIndex + 1, 1);
					}
					that.gotoSkip()
				},
				//去跳绳前先判断是否有设备
				gotoSkip() {
					if (this.macItem.length == 0) {
						this.$toast("请先绑定设备");
						return
					};
				
					if (this.macItem.length == 1) {
						this.mac = this.macItem[0].mac;
						this.macName = this.macItem[0].macName;
						this.deviceModel = this.macItem[0].deviceModel;
						this.gotoSkip2();
						return;
					}
					var _self = this;
					_self.macShow = true;
				},
				//前去app跳绳的跳绳页面ios安卓自行加载
				gotoSkip2() {
					var _self = this;
					if (/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)) { //判断iPhone|iPad|iPod|iOS
						try{
							window.webkit.messageHandlers.lstNative.postMessage({
								'method': 'ropeSkipNormal',
								"mac": _self.mac,
								"macName": _self.macName,
								"deviceModel":_self.deviceModel,
							})
						}catch(e){
							console.log(e)
						}
					} else if (/(Android)/i.test(navigator.userAgent)) { //判断Android
						window.location.href = 'rehealth://competition/para?action=skipping'+'&macName=' + _self.macName + '&culbId' + _self.culbId+'&category=0'+'&mac='+_self.mac+'&deviceModel='+_self.deviceModel
					}
					//去跳绳结束后要重新加载一些跳绳的条件
					_self.initDetail();
					
				}
			}
		})
	</script>
</html>
