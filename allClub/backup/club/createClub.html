<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
		<title>创建俱乐部(1/3)</title>
		<!-- 引入样式文件 -->
		<link rel="stylesheet" href="../../common/css/vant-rem.css">
		<link rel="stylesheet" href="css/clubCreateCompetition.css">
		<script type="text/javascript">
			document.documentElement.style.fontSize = document.documentElement.clientWidth / 7.5 + 'px';
		</script>
		<!-- <script src="https://cdn.bootcss.com/vConsole/3.3.4/vconsole.min.js"></script>
		<script>
			// init vConsole
			var vConsole = new VConsole();
			console.log('Hello world');
		</script> -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.6/cropper.min.js"></script>
		<script src="js/exif.js"></script>
		<script src="js/upload.js"></script>
		<style type="text/css">
			.cropper-container {
				display: none;
			}

			.van-hairline--top-bottom::after,
			.van-hairline-unset--top-bottom::after {
				border-width: 0;
			}

			.van-uploader__preview-image {
				width: 2.4rem;
				height: 2.4rem;
				margin: 0 auto;
			}

			.van-uploader__preview-delete {
				background-color: transparent;
			}

			.van-uploader__preview-image img {
				width: 100%;
				height: 100%;
			}
		</style>
	</head>
	<body>
		<div id="app" v-cloak>
			<div>
				<div>
					<div class="laberDiv">俱乐部形象
					</div>
					<div style="padding:.5rem 0.2rem .5rem 0.2rem;text-align: center;">
						<van-uploader upload-icon="plus" :deletable="false" :max-count="1" :after-read="afterRead" />
						<div class="van-image van-uploader__preview-image" v-if="hasImg">
							<img :src="previewImg" class="van-image__img">
						</div>
					</div>

					<div class="" style="color: #999;font-size: .28rem;text-align: center;">请选择一张图片作为俱乐部头像</div>
				</div>

				<van-button round class="submit" block @click="goNext()" :color="imgUrl?bgc:bgcgrey">下一步</van-button>

				<van-overlay :show="overlayShow" @click="show = false" style="align-items: center;display: flex;justify-content: center;">
					<van-loading size="0.7rem" color="#fff" vertical>
						<p style="color:#fff;font-size:0.24rem">正在上传...</p>
					</van-loading>
				</van-overlay>
			</div>
		</div>
	</body>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vant@2.9/lib/vant.min.js"></script>
	<script src="js/area.js"></script>

	<script src="../../common/js/network.js"></script>
	<script type="text/javascript">
		new Vue({
			el: '#app',
			data() {
				return {
					bgc: "linear-gradient(to right, #FF6A88, #FF5136 )",
					bgcgrey: '#999',
					imgUrl: localStorage.getItem('clubForm') ? JSON.parse(localStorage.getItem('clubForm')).photo : null,
					fileList: localStorage.getItem('clubForm') ? [{
						url: JSON.parse(localStorage.getItem('clubForm')).photo,
						isImage: true
					}] : [],
					submitform: JSON.parse(localStorage.getItem('clubForm')) || {
						"name": "",
						"province": "",
						"city": "",
						"county": "",
						"type": "", //00学校,01公司,02健身房,03爱好者
						"label": "00", //00跳绳
						"isPublic": "", // Y(官方比赛)，N(非官方比赛)
						"introduce": "", //简介
						"creator": "", //创建者
					},
					overlayShow: false,
					hasImg: false,
					previewImg: ""

				};
			},
			created() {
				if (this.imgUrl) {
					this.hasImg = true;
					this.previewImg = this.imgUrl;
				}
			},
			methods: {
				//文件选择之后的回调压缩裁剪处理
				afterRead(file) {
					console.log(file);
					this.fileList[0] = file;
					this.hasImg = true;
					this.previewImg = file.content;
					this.overlayShow = true;
					setTimeout(() => {
						this.uploadPicReady(this.fileList[0]);
					}, 500)
				},
				uploadPicReady(file) {
					console.log("原始的文件")
					var _self = this;
					try {
						var cropper = new Cropper(document.getElementsByClassName("van-image__img")[0], {
							aspectRatio: 16 / 16,
							viewMode: 1,
							dragMode: "move",
							background: false,
							autoCropArea: 1,
							crop: function(e) {
								var canvas = cropper.getCroppedCanvas();
								dataURLtoFile(canvas.toDataURL('image/jpeg'), file.file.name, function(dataURLtoFileData) {
									_self.fileList[0].file = dataURLtoFileData;
									console.log(dataURLtoFileData)
									UpladFile({
										file: dataURLtoFileData
									}, function(item) {
										_self.fileList[0] = item;
										_self.previewImg = item.content
										_self.uploadPic(item.file)
									})
								})
							}
						})

					} catch (e) {
						console.log(e)
						_self.isClick = false;
						_self.overlayShow = false;
					}

				},
				//上传图片
				uploadPic(file) {
					console.log("准备上传的文件")
					var _self = this;
					var formdata = new FormData();
					formdata.append("file", file);

					ajax({
						type: "post",
						url: "oss/upload/file",
						contentType: "multipart/form-data",
						data: formdata,
						success: function(res) {
							if (res.code == 0) {
								console.log(res.data)
								_self.overlayShow = false;
								_self.imgUrl = res.data.url;
								ajax({
									type: "post",
									url: "contentSecurity/aliyun/imageScan",
									data: {
										content: _self.imgUrl
									},
									success: function(res) {
										if (res.code == 0) {

										} else {
											_self.isClick = false;
											_self.overlayShow = false;
											_self.fileList = []
											_self.$toast("图片审核未通过，请重新上传！");
										}
									},
									error: function() {
										_self.isClick = false;
										_self.overlayShow = false;
										_self.fileList = []
										console.log("error")
									}
								})
							} else {
								_self.$toast(res.msg);
							}
						},
						error: function() {
							console.log("error")
						}
					})
				},
				goNext() { //去下一步
					if (!this.imgUrl) return;
					this.submitform.photo = this.imgUrl;
					localStorage.setItem('clubForm', JSON.stringify(this.submitform));
					window.location.href = 'createClub2.html';
				},
			}
		})
	</script>
