<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
		<title>创建活动(2/2)</title>
		<!-- 引入样式文件 -->
		<link rel="stylesheet" href="../../common/css/vant-rem.css">
		<link rel="stylesheet" href="css/clubCreateCompetition.css">
		<script type="text/javascript">
			document.documentElement.style.fontSize = document.documentElement.clientWidth / 7.5 + 'px';
		</script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.6/cropper.min.js"></script>
		<script src="js/exif.js"></script>
		<script src="js/upload.js"></script>
		<!-- <script src="https://cdn.bootcss.com/vConsole/3.3.4/vconsole.min.js"></script>
				<script>
					// init vConsole
				        var vConsole = new VConsole();
				        console.log('Hello world');
				    </script> -->
		<style type="text/css">
			.cropper-container {
				display: none;
				height: 0;
			}

			.content-input {
				min-height: auto;
			}

			.van-uploader__preview-image {
				width: 2.4rem;
				height: 2.4rem;
				margin: 0 auto;
			}

			.van-uploader__preview-delete {
				background-color: transparent;
			}

			.van-uploader__preview-image img {
				width: 100%;
				height: 100%;
			}
		</style>
	</head>
	<body>
		<div id="app" v-cloak>
			<div>
				<div style="border-bottom: 1px solid #f8f8f8;padding-bottom: .4rem;">
					<div class="laberDiv">活动海报
					</div>
					<div style="padding:.5rem 0.2rem .5rem 0.2rem;text-align: center;">
						<van-uploader upload-icon="plus" :deletable="false" :max-count="1" :after-read="afterRead" />
						<div class="van-image van-uploader__preview-image" v-if="hasImg">
							<img :src="previewImg" class="van-image__img">
						</div>
						<!-- <van-uploader upload-icon="plus" 
							@delete="delpic"
							v-model="fileList" :max-count="1" :after-read="afterRead" /> -->
					</div>
					<div class="" style="color: #999;font-size: .28rem;text-align: center;">请选择一张图片作为活动的海报</div>
				</div>

				<div style="border-bottom: 1px solid #f8f8f8;">
					<div class="laberDiv">活动内容
						<span v-if="isSubmit&&!submitform.info" class="errorSpan">{{"请输入活动内容"}}</span></div>
					<div style="padding:0 0.2rem 0.2rem 0.2rem;">
						<van-field v-model="submitform.info" :input="contentChange()" class="content-input" rows="5" autosize type="textarea"
						 maxlength="300" placeholder="请输入活动内容吧~" show-word-limit />
					</div>
				</div>
				<van-button round class="submit" block :color="!submitform.info||fileList.length==0?bgcgrey:bgc" @click="submitFormData">创建</van-button>
			</div>
		</div>
	</body>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vant@2.9/lib/vant.min.js"></script>
	<script src="js/DateTime.js"></script>

	<script src="../../common/js/network.js"></script>
	<script>
		var handler = function(e) {
			e.preventDefault();
		}
		new Vue({
			el: '#app',
			data() {
				return {
					bgc: "linear-gradient(to right, #FF6A88, #FF5136 )",
					bgcgrey: '#999',
					isClick: false,
					activeNames: 0,
					matchName: '',
					clubId: "",
					isSubmit: false,
					jlinput: false,
					overlayShow: false,

					startTimeColumns: [],
					startTimeShow: false,
					startTime: [],

					endTimeColumns: [],
					endTimeShow: false,

					fileList: localStorage.getItem('activityForm') ? [{
						url: JSON.parse(localStorage.getItem('activityForm')).picUrl,
						isImage: true
					}] : [],
					hasImg: false,
					previewImg: "",

					form: {
						mc: "",
						start: "",
						end: "",

					},
					submitform: JSON.parse(localStorage.getItem('activityForm')) || {
						"startTime": "",
						"endTime": "",
						"title": "",
						"picUrl": "",
						"info": ""
					}

				};
			},
			watch: {
				startTimeShow: function(val) {
					if (val) {
						document.getElementsByTagName('body')[0].addEventListener('touchmove', this.handler, {
							passive: false
						});
					} else {
						document.getElementsByTagName('body')[0].removeEventListener('touchmove', this.handler, {
							passive: false
						});
					}
				},
				endTimeShow: function(val) {
					if (val) {
						document.getElementsByTagName('body')[0].addEventListener('touchmove', this.handler, {
							passive: false
						});
					} else {
						document.getElementsByTagName('body')[0].removeEventListener('touchmove', this.handler, {
							passive: false
						});
					}
				}
			},
			created() {

			},
			methods: {
				//开始时间的回调
				onstartTimeConfirm(value, index) {
					if (value[0] == "立即开始") {
						var nowTime = DateTime.timeStamp2String('ymdhm');
						this.form.start = DateTime.timeStamp2String('mdhm');

						this.submitform.startTime = DateTime.getSjc(nowTime);
						this.initEndTime(DateTime.sjc2time('ymdhms', DateTime.getSjc(nowTime) + 3600000));
					} else {
						this.form.start = DateTime.sjc2time('mdhm2', DateTime.getSjc(value[0] + " " + value[1].text))

						this.submitform.startTime = DateTime.getSjc(value[0] + " " + value[1].text);
						this.initEndTime(value[0] + " " + value[1].text);
					}
					this.form.end = "";
					this.submitform.endTime = "";
					this.startTimeShow = false;

				},
				//开始时间的改变
				onstartTimeChange(picker, value, index) {
					picker.setColumnValues(1, this.startTime[value[0]]);
				},
				//初始化结束时间
				initEndTime(time) {
					var num = 5;
					var endTime = DateTime.initEnd(time, 2);
					num = 1
					if (time) {
						var starth = DateTime.timeStamp2String("h", DateTime.getTime(time))
						var endh = Number(starth) + num;
					} else {
						var starth = DateTime.getHours()
						var endh = Number(starth) + num;
					}

					if (endh > 23) {
						this.endTimeColumns = [{
								values: Object.keys(endTime),
							},
							{
								values: endTime[DateTime.getDateByNum(1, time)],
							}
						]
					} else {
						this.endTimeColumns = [{
								values: Object.keys(endTime),
							},
							{
								values: endTime[DateTime.getDateByNum(0, time)],
							}
						]
					}

					this.endTime = endTime;
				},
				//结束时间的回调
				onendTimeConfirm(value, index) {
					var _self = this;
					this.form.end = DateTime.sjc2time('mdhm2', DateTime.getSjc(value[0] + " " + value[1].text))
					this.submitform.endTime = DateTime.getSjc(value[0] + " " + value[1].text);
					if (this.submitform.startTime) {
						var timeArray = DateTime.needYearOrNot2(this.submitform.startTime, this.submitform.endTime);
						this.form.start = timeArray[0];
						this.form.end = timeArray[1];
					}
					this.endTimeShow = false;
					setTimeout(function() {
						_self.activeNames = 0;
					}, 300)
				},
				//结束时间的改变
				onendTimeChange(picker, value, index) {
					//this.form.end = value[0] + " " + value[1].text;
					picker.setColumnValues(1, this.endTime[value[0]]);
				},
				delpic() {
					this.submitform.picUrl = "";
					this.fileList = [];
				},
				//文件选择之后的回调压缩裁剪处理
				afterRead(file) {
					console.log(file);
					this.fileList[0] = file;
					this.hasImg = true;
					this.previewImg = file.content;
					setTimeout(() => {
						this.uploadPicReady(this.fileList[0]);
					}, 500)
				},
				uploadPicReady(file) {
					console.log("原始的文件")
					console.log(file.file)
					var _self = this;
					try {
						var cropper = new Cropper(document.getElementsByClassName("van-image__img")[0], {
							aspectRatio: 16 / 16,
							viewMode: 1,
							dragMode: "move",
							background: false,
							autoCropArea: 1,
							crop: function(e) {
								var canvas = cropper.getCroppedCanvas();
								dataURLtoFile(canvas.toDataURL('image/jpeg'), file.file.name, function(dataURLtoFileData) {
									_self.fileList[0].file = dataURLtoFileData;
									console.log(dataURLtoFileData)
									UpladFile({
										file: dataURLtoFileData
									}, function(item) {
										_self.fileList[0] = item;
										_self.previewImg = item.content
										_self.uploadPic(item.file)
									})
								})
							}
						})

					} catch (e) {
						console.log(e)
						_self.isClick = false;
						_self.overlayShow = false;
					}

				},
				//上传图片
				uploadPic(file) {
					console.log("准备上传的文件")
					console.log(file)
					var _self = this;
					_self.overlayShow = true;
					var formdata = new FormData();
					formdata.append("file", file);

					ajax({
						type: "post",
						url: "oss/upload/file",
						contentType: "multipart/form-data",
						data: formdata,
						success: function(res) {
							if (res.code == 0) {
								_self.submitform.picUrl = res.data.url;
								// _self.submitFormDataSecond();
							} else {
								_self.overlayShow = false;
								_self.$toast(res.msg);
							}
						},
						error: function() {
							console.log("error")
						}
					})
				},
				//提交表单数据
				submitFormData() {
					var _self = this;
					if (_self.isClick) {
						return;
					}
					if (!this.submitform.info || this.fileList.length == 0) {
						return;
					}
					_self.isClick = true
					this.isSubmit = true;
					console.log(this.submitform)
					// for (var key in this.submitform) {
					// 	if (this.submitform[key] === "") {
					// 		_self.isClick = false;
					// 		return;
					// 	}
					// }
					if (_self.fileList.length == 0) {
						_self.isClick = false;
						return;
					};
					// _self.uploadPicReady(_self.fileList[0]);
					_self.submitFormDataSecond();
				},
				submitFormDataSecond() {
					var _self = this;
					ajax({
						type: "post",
						url: "contentSecurity/aliyun/imageScan?userId=" + JSON.parse(localStorage.getItem("appInfo")).userId,
						data: {
							content: this.submitform.picUrl
						},
						success: function(res) {
							if (res.code == 0) {
								ajax({
									type: "post",
									url: "club/activity/create",
									data: _self.submitform,
									success: function(res) {
										if (res.code == 0) {
											_self.overlayShow = false;
											localStorage.removeItem('activityForm');
											_self.$toast("活动创建成功！");
											_self.createNotice(res.data[0].id);
										} else {
											_self.isClick = false;
											_self.overlayShow = false;
											_self.$toast(res.msg);
										}
									},
									error: function() {
										_self.isClick = false;
										console.log("error")
									}
								})
							} else {
								_self.isClick = false;
								_self.overlayShow = false;
								_self.fileList = []
								_self.$toast("图片审核未通过，请重新上传！");
							}
						},
						error: function() {
							_self.isClick = false;
							_self.overlayShow = false;
							_self.fileList = []
							console.log("error")
						}
					})
				},
				createNotice(activityId) {
					var _self = this;
					ajax({
						type: "post",
						url: "club/saveClubNotice",
						data: {
							title: "有新的活动," + _self.submitform.title,
							content: _self.submitform.info,
							clubId: _self.submitform.clubId,
							type: "02",
							relatedId: activityId
						},
						success: function(res) {
							if (res.code == 0) {
								_self.gotoDetail(activityId);
							} else {
								_self.$toast(res.msg);
							}
						},
						error: function() {
							console.log("error")
						}
					})
				},
				gotoDetail(activityId) {
					var _self = this;
					if (/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)) { //判断iPhone|iPad|iPod|iOS
						try {
							window.webkit.messageHandlers.lstNative.postMessage({
								'method': 'clubToActivityDetail',
								"activityId": activityId,
							})
						} catch (err) {
							console.log('window.webkit.messageHandlers 回传Id failed')
						}

					} else if (/(Android)/i.test(navigator.userAgent)) { //判断Android
						var str = 'activityId=' + activityId;
						window.android.clubToActivityDetail(str);
					}
					window.location.href = "activityDetail.html?id=" + activityId + '&clubId=' + _self.submitform.clubId +
						'&isAttend=1'

				},
				titleChange() {
					this.submitform.title = this.submitform.title.replace(
						/[^\u4E00-\u9FA5|\d|\a-zA-Z|\r\n\s,.?!，。#￥$%\`~^？！@…—&$=()\-+/*{}【】\\（）[\]]|\s/g, '')
				},
				contentChange() {
					this.submitform.info = this.submitform.info.replace(
						/[^\u4E00-\u9FA5|\d|\a-zA-Z|\r\n\s,.?!，。#￥$%\`~^？！@…—&$=()\-+/*{}【】\\（）[\]]|\s/g, '')
				}

			}
		})
	</script>
</html>
