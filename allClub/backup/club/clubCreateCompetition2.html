<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0,
			minimum-scale=1.0, viewport-fit=cover">
		<title>创建俱乐部比赛(2/2)</title>
		<!-- 引入样式文件 -->
		<link rel="stylesheet" href="../../common/css/vant-rem.css">
		<link rel="stylesheet" href="css/creat2.css">
		<style>

	</style>
	</head>

	<body>
		<div id="app" v-cloak>
			<div>
				<div class="item_box">
					<div>
						<van-cell class="pk_cell2"
							:class="form.pkRepeatTimes.indexOf('请选择')!=-1?'':'chosed'"
							@click="playTimesShow= true" title="比赛次数" is-link
							:value="form.pkRepeatTimes" />
						</div>
					</div>

					<div class="item_box">
						<div>
							<van-cell class="pk_cell2"
								:class="form.pkStart.indexOf('请选择')!=-1?'':'chosed'"
								@click="startTimeShow= true" title="开始时间" is-link :value="form.pkStart"
								/>
							</div>
						</div>
						<div class="item_box">
							<div>
								<van-cell class="pk_cell2"
									:class="form.pkEnd.indexOf('请选择')!=-1?'':'chosed'"
									@click="endTimeShow= true" title="结束时间" is-link :value="form.pkEnd" />
								</div>
							</div>
							<div class="item_box">
								<div class="laber">
									比赛模式
								</div>
								<div>
									<van-radio-group @change="gameRewardChange" v-model="form.pkGameReward"
										direction="horizontal">
										<van-radio name="1">无奖励</van-radio>
										<van-radio name="2">自定义奖励</van-radio>
									</van-radio-group>
								</div>
								<div class="pkName_box" v-if="form.pkGameReward==2">
									<van-field v-model="submitform.gameReward" rows="2" type="textarea"
										maxlength="20"
										placeholder="请输入比赛奖励吧~" show-word-limit />
									</div>
								</div>

							</div>


							<div class="btn_box">
								<van-button class="creatMatch" :class="canNext?'':'creatMatch2'"
									style="width: 4rem;" @click="submitFormData">创建
								</van-button>
							</div>


							<van-popup v-model="playTimesShow" position="bottom">
								<van-picker show-toolbar title="比赛次数" :columns="playTimesColumns"
									:default-index="2"
									@cancel="playTimesShow= false" @confirm="onplayTimesConfirm" />
								</van-popup>
								<van-popup v-model="startTimeShow" position="bottom">
									<van-picker show-toolbar title="开始时间" :columns="startTimeColumns"
										@cancel="startTimeShow= false"
										@confirm="onstartTimeConfirm" @change="onstartTimeChange" />
									</van-popup>

									<van-popup v-model="endTimeShow" position="bottom">
										<van-picker show-toolbar title="结束时间" :columns="endTimeColumns"
											@cancel="endTimeShow= false"
											@confirm="onendTimeConfirm" @change="onendTimeChange" />
										</van-popup>
									</div>
								</body>
								<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
								<script src="https://cdn.jsdelivr.net/npm/vant@2.9/lib/vant.min.js"></script>
								<script src="js/DateTime.js"></script>
								<script src="../../common/js/network.js"></script>
								<script>
	var handler = function (e) {
		e.preventDefault();
	}
	new Vue({
		el: '#app',
		data() {
			return {
				isClick: false,
				playTimesShow: false,
				playTimesColumns: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, "不限次数，比赛期间取最好成绩"],
				startTimeColumns: [],
				startTimeShow: false,
				startTime: [],

				endTimeColumns: [],
				endTimeShow: false,



				form: {
					pkRepeatTimes: "请选择比赛次数",
					pkStart: "请选择开始时间",
					pkEnd: "请选择结束时间",
					pkGameReward:""
				},
				submitform: {
					"startTime": "",
					"endTime": "",
					"name": "",
					"mode": "", //比赛模式: 2(倒计时)/3(倒计数)
					"type": "", //比赛类型: team(团队赛)/personal(个人赛)
					"isOfficial": true, // true(官方比赛)，false(非官方比赛)
					"modeValue": "", //倒计时/秒, 倒计数/个
					"repeatTimes": "", //比赛  -1:表示不限制比赛次数
					"invitationCode": "", //邀请码
					"isVerify": "", //是否需要邀请码   true(需要)
					"gameReward": "", //比赛奖励
					"teamPersonLimit": "" //团队人数

				},
				canNext:false

			};
		},
		watch: {
			submitform: {
				handler: function (val, oldval) {
					this.checkIsNull()
				},
				deep: true
			},
			playTimesShow: function (val) {
				if (val) {
					document.getElementsByTagName('body')[0].addEventListener('touchmove', this.handler, {
						passive: false
					});
				} else {
					document.getElementsByTagName('body')[0].removeEventListener('touchmove', this.handler, {
						passive: false
					});
				}
			},
			startTimeShow: function (val) {
				if (val) {
					document.getElementsByTagName('body')[0].addEventListener('touchmove', this.handler, {
						passive: false
					});
				} else {
					document.getElementsByTagName('body')[0].removeEventListener('touchmove', this.handler, {
						passive: false
					});
				}
			},
			endTimeShow: function (val) {
				if (val) {
					document.getElementsByTagName('body')[0].addEventListener('touchmove', this.handler, {
						passive: false
					});
				} else {
					document.getElementsByTagName('body')[0].removeEventListener('touchmove', this.handler, {
						passive: false
					});
				}
			}
		},
		created() {
			var competitionForm=JSON.parse(localStorage.getItem("competitionForm"));
			var descriptForm=JSON.parse(localStorage.getItem("descriptForm"));
			this.submitform=Object.assign(this.submitform,competitionForm);
			this.form=Object.assign(this.form,descriptForm);

			
			var startTime = DateTime.initStart();
			this.startTimeColumns = [{
				values: Object.keys(startTime),
			},
			{
				values: startTime[DateTime.getDateByNum(0)],
			}
			]
			this.startTime = startTime;
			//先初始化结束时间
			this.initEndTime();

		},
		methods: {
			//检查是否有空项
			checkIsNull() {
				localStorage.setItem('competitionForm', JSON.stringify(this.submitform));
				localStorage.setItem('descriptForm', JSON.stringify(this.form));
				let submitform = this.submitform;
				if (!(submitform.repeatTimes  && submitform.startTime && submitform.endTime&&submitform.gameReward)) {
					this.canNext = false;
				} else {
					if (this.form.pkGameReward == 2 && submitform.gameReward) {
						this.canNext = true;
					} else if(this.form.pkGameReward == 1){
						this.canNext = true;
					}else{
						this.canNext = false;
					}
				}

			},
			
			//奖励的改变
			gameRewardChange(name) {
				if (name == 1) {
					this.submitform.gameReward = "无奖励"
				}else{
					this.submitform.gameReward=""
				}
			},

			//比赛次数的回调
			onplayTimesConfirm(value, index) {
				if (index == 10) {
					this.form.pkRepeatTimes = value;
					this.submitform.repeatTimes = -1;
				} else {
					this.form.pkRepeatTimes = value + "次内取最好成绩"
					this.submitform.repeatTimes = value;
				}

				this.playTimesShow = false;
			},
			//开始时间的回调
			onstartTimeConfirm(value, index) {
				if (value[0] == "立即开始") {
					var nowTime = DateTime.timeStamp2String('ymdhm');
					this.form.pkStart = DateTime.timeStamp2String('mdhm');

					this.submitform.startTime = DateTime.getSjc(nowTime);
					this.initEndTime(DateTime.sjc2time('ymdhms', DateTime.getSjc(nowTime) + 3600000));
				} else {
					this.form.pkStart = DateTime.sjc2time('mdhm2', DateTime.getSjc(value[0] + " " + value[1].text))

					this.submitform.startTime = DateTime.getSjc(value[0] + " " + value[1].text);
					this.initEndTime(value[0] + " " + value[1].text);
				}
				this.form.pkEnd = "请选择结束时间";
				this.submitform.endTime = "";
				this.startTimeShow = false;

			},
			//开始时间的改变
			onstartTimeChange(picker, value, index) {
				picker.setColumnValues(1, this.startTime[value[0]]);
			},
			//初始化结束时间
			initEndTime(time) {
				var num = 1;
				var endTime = DateTime.initEnd(time, 2);
				
				if (time) {
					var starth = DateTime.timeStamp2String("h", DateTime.getTime(time))
					var endh = Number(starth) + num;
				} else {
					var starth = DateTime.getHours()
					var endh = Number(starth) + num;
				}

				if (endh > 23) {
					this.endTimeColumns = [{
						values: Object.keys(endTime),
					},
					{
						values: endTime[DateTime.getDateByNum(1, time)],
					}
					]
				} else {
					this.endTimeColumns = [{
						values: Object.keys(endTime),
					},
					{
						values: endTime[DateTime.getDateByNum(0, time)],
					}
					]
				}

				this.endTime = endTime;
			},
			//结束时间的回调
			onendTimeConfirm(value, index) {
				var that = this;
				this.form.pkEnd = DateTime.sjc2time('mdhm2', DateTime.getSjc(value[0] + " " + value[1].text))
				this.submitform.endTime = DateTime.getSjc(value[0] + " " + value[1].text);
				if (this.submitform.startTime) {
					var timeArray = DateTime.needYearOrNot2(this.submitform.startTime, this.submitform.endTime);
					this.form.pkStart = timeArray[0];
					this.form.pkEnd = timeArray[1];
				}
				this.endTimeShow = false;

			},
			//结束时间的改变
			onendTimeChange(picker, value, index) {
				picker.setColumnValues(1, this.endTime[value[0]]);
			},
			//最后的创建比赛
			submitFormData() {
				if (!this.canNext) return;
				var that = this;
				if (that.isClick) {
					return;
				}
				that.isClick = true
				
				this.submitform.isOfficial = false;
				this.submitform.promoterId = JSON.parse(localStorage.getItem("appInfo")).userId;
				
				ajax({
					type: "post",
					url: "club/competition/create",
					data: this.submitform,
					success: function (res) {
						that.isClick = false;
						if (res.code == 0) {
							that.$toast("比赛创建成功！");
							//that.gotoDetail(res.data);
							that.createNotice(res.data);
							localStorage.removeItem("competitionForm")
							localStorage.removeItem("descriptForm")
						} else {
							that.$toast(res.msg);
						}
					},
					error: function () {
						that.isClick = false;
						console.log("error")
					}
				})

			},
			createNotice(item) {
					var that = this;
					var title = "";
					if (that.submitform.mode == 2) {
						if (that.submitform.modeValue == 30) {
							title = that.submitform.modeValue + "秒钟倒计时跳"
						} else {
							title = (parseInt((that.submitform.modeValue) / 60)) + "分钟倒计时跳"
						}
					} else {
						title = that.submitform.modeValue + "个倒计数跳"
					}
					ajax({
						type: "post",
						url: "club/saveClubNotice",
						data: {
							title: "有新的比赛," + title,
							content: "有新的比赛," + that.submitform.name,
							clubId: getQueryString("clubId") ,
							type: "01",
							relatedId: item[0].id
						},
						success: function(res) {
							if (res.code == 0) {
								that.gotoDetail(item);
							} else {
								that.$toast(res.msg);
							}
						},
						error: function() {
							console.log("error")
						}
					})
				},
				gotoDetail(item) {
					try {
						if (isIOS) { //判断iPhone|iPad|iPod|iOS
							window.webkit.messageHandlers.lstNative.postMessage({
								'method': 'clubToCompetitionDetail',
								"matchId": item[0].id,
								"url": "/h5/h5V2/allClub/club/clubCompetitionDetail.html?id=" + item[0].id + '&userId=' + JSON.parse(
									localStorage.getItem("appInfo")).userId + '&clubId=' + getQueryString("clubId")
							});
						} else {
							var str = 'matchId=' + item[0].id;
							window.android.clubToCompetitionDetail(str);
							window.location.href = "clubCompetitionDetail.html?id=" + item[0].id + "&clubId=" + getQueryString("clubId")
						}
					} catch (err) {
						console.log(err)
					}
					
				},
		}
	
	})
</script>
</html>