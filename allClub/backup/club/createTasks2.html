<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
		<title>创建任务(2/2)</title>
		<!-- 引入样式文件 -->
		<link rel="stylesheet" href="https://oss.laisitech.com/04bb3a7d-8774-4441-9004-e77b0ae7e0aa.css">
		<link rel="stylesheet" href="css/clubCreateCompetition.css">
		<link rel="stylesheet" href="css/tasks.css">
		<script type="text/javascript">
			document.documentElement.style.fontSize = document.documentElement.clientWidth / 7.5 + 'px';
		</script>
		<!-- <script src="https://cdn.bootcss.com/vConsole/3.3.4/vconsole.min.js"></script>
				<script>
					// init vConsole
				        var vConsole = new VConsole();
				        console.log('Hello world');
				    </script> -->
		<style type="text/css">
			.van-field--error .van-field__control,
			.van-field--error .van-field__control::placeholder {
				color: red;
				-webkit-text-fill-color: red
			}

			.van-hairline--top-bottom::after,
			.van-hairline-unset--top-bottom::after {
				border-width: 0;
			}

			.van-cell::after {
				border-bottom: 0;
			}

			.clubtype {
				font-size: .24rem;
				vertical-align: middle;
				text-align: center;
				color: #999;
			}

			.clubtype .clubtypeicon {
				width: .72rem;
				height: .72rem;
				border-radius: 100%;
				background-color: #e5e5e5;
				margin-bottom: .2rem;
			}

			.clubtype .active {
				background-color: #1182ff;
			}

			.clubtag .active {
				background-color: #ff7518;
			}

			.clubtype .clubtypeicon img {
				width: .4rem;
				height: .4rem;
			}

			.clubtype .clubtypeicon img:nth-child(1) {
				width: .48rem;
				height: .36rem;
			}

			.clubtype .clubtypeicon img:nth-child(3) {
				width: .48rem;
				height: .32rem;
			}

			.clubtype .clubtypeicon img:nth-child(4) {
				width: .40rem;
				height: .36rem;
			}

			.clubtag .clubtypeicon img:nth-child(1) {
				width: .32rem;
				height: .48rem;
			}

			.chosed .van-cell__value {
				color: #1F1F1F;
			}

			.van-action-sheet__cancel {
				color: #2E80F3;
			}

			.van-picker__title {
				font-size: .28rem;
			}

			.van-action-sheet__gap {
				background-color: rgba(0, 0, 0, .5);
			}

			.van-picker__toolbar {
				background-color: #f8f8f8;
			}

			.van-action-sheet__cancel,
			.van-action-sheet__item {
				font-size: .28rem;
			}

			.van-picker-column__item--selected {
				font-size: .36rem;
			}

			#zq2 .van-cell__title {
				flex: 2
			}

			#zq2 .van-cell__value span {
				font-size: .28rem;
				color: #1f1f1f;
			}
		</style>
	</head>
	<body>
		<div id="app" v-cloak>
			<div>
				<div style="border-bottom:1px solid #f5f5f5">
					<van-row>
						<van-col span="7" class="laberTitle">
							任务目标
						</van-col>
						<van-col span="17" class="laberContent">
							<van-field v-model="submitform.target" :input="targeChange()"
								:error="isSubmit&&!submitform.target?true:false" style="padding-left: 0;"
								placeholder="请输入跳绳目标个数" />
						</van-col>
					</van-row>
				</div>
				<div @click="timeshow = true" style="border-bottom:1px solid #f5f5f5">
					<van-cell title="任务周期" :class="form.zq.indexOf('选择')!=-1?'':'chosed'" is-link :value="form.zq">
					</van-cell>
				</div>
				<div id="zq2" @click="zq2show=true" v-if="form.zq2title" style="border-bottom:10px solid #f5f5f5">
					<van-cell :title="form.zq2title" is-link :value="form.zq2"></van-cell>
				</div>
				<div>
					<van-popup position="bottom" :style="{height: '45%'}" v-model="zq2show">
						<van-datetime-picker v-model="currentDate" @change="zq2change" :filter='filter'
							@cancel="zq2show = false" @confirm="zq2confirm" type="date" title="请选择任务截止时间"
							:min-date="minDate" :formatter="formatter" />
					</van-popup>
				</div>
				<van-action-sheet cancel-text="取消" close-on-click-action v-model="timeshow" :round="false"
					:actions="timeaction" @select="onSelectTime"></van-action-sheet>
				<div @click="membershow = true" style="border-bottom:1px solid #f5f5f5">
					<van-cell title="参与成员" :class="form.cy.indexOf('选择')!=-1?'':'chosed'" is-link :value="form.cy">
					</van-cell>
				</div>
				<van-action-sheet cancel-text="取消" close-on-click-action v-model="membershow" :round="false"
					:actions="memberaction" @select="onSelectMember"></van-action-sheet>
				<div>
					<div class="van-cell"><span>任务标签</span></div>
					<van-row type="flex" justify="space-around">
						<van-col span="6">
							<div class="clubtype clubtag" @click="clubtag = 1">
								<div class="clubtypeicon ub ub-ac ub-pc" style="margin:0 auto .2rem;"
									:class="clubtag==1?'active':''">
									<img src="img/jumpskip.png" alt="">
								</div>
								<div>跳绳</div>
							</div>
						</van-col>
						<van-col span="6"></van-col>
						<van-col span="6"></van-col>
						<van-col span="6"></van-col>
					</van-row>
				</div>

				<van-button round class="submit" block
					:color="clubtag&&submitform.period&&submitform.target&&submitform.assignType?bgc:bgcgrey"
					@click="submitFormData">创建</van-button>

				<van-popup v-model="endTimeShow" position="bottom">
					<van-picker show-toolbar title="选择任务截止时间" :columns="endTimeColumns" @cancel="endTimeShow = false"
						@confirm="onendTimeConfirm" />
				</van-popup>
			</div>
		</div>
	</body>
	<script src="https://oss.laisitech.com/0bb12bf1-cb87-4d2c-a724-8a7c25b7ae04.js "></script>
	<script src="https://oss.laisitech.com/6172e6c1-f460-40ac-97ba-31c8526f2e16.js"></script>
	<script src="js/DateTime.js"></script>
	<script src="../../common/js/network.js"></script>
	<script type="text/javascript">
		function getNextMonday() { //获取当前日期的下一个周一的时间戳
			var Stamp;
			Stamp = new Date();
			var num = 7 - Stamp.getDay() + 1;
			Stamp.setDate(Stamp.getDate() + num);

			var year = Stamp.getFullYear(); //获取完整的年份(4位,1970-????)
			var month = Stamp.getMonth() + 1; //获取当前月份(0-11,0代表1月)
			var mvar = '';
			if (month < 10) {
				mvar = '0' + month;
			} else {
				mvar = month + '';
			}
			var day = Stamp.getDate();
			var dvar = '';
			if (day < 10) {
				dvar = '0' + day;
			} else {
				dvar = day + '';
			}
			var finalDate = year + '/' + mvar + '/' + dvar;
			return DateTime.getSjc(finalDate);
		}

		function getMonthTimeStamp() { //判断是否过了15号判断获取的时间戳是当前还是下月一号
			var year = DateTime.timeStamp2String("y"); //获取当前日期的年份
			var month = DateTime.timeStamp2String("M"); //获取当前日期的月份
			var day = DateTime.timeStamp2String("d"); //获取当前日期的日
			if (day <= 15) {
				return Math.round(new Date());
			} else {
				var month2 = parseInt(month) + 1;
				var year2 = year;
				if (month2 == 13) {
					year2 = parseInt(year) + 1;
					month2 = 1;
				}
				var day2 = "01";
				if (month2 < 10) {
					month2 = '0' + month2;
				}

				var t2 = year2 + '/' + month2 + '/' + day2;
				return DateTime.getSjc(t2);
			}
		}

		new Vue({
			el: '#app',
			data() {
				return {
					iscorporate: parseInt(getQueryString('iscorporate')), //为1是企业俱乐部
					bgc: "linear-gradient(to right, #FF6A88, #FF5136 )",
					bgcgrey: '#999',
					clubtag: '',
					timeshow: false,
					membershow: false,
					timeaction: [{
						name: '每天（每天完成一次目标）',
						val: '00'
					}, {
						name: '每周',
						val: '01'
					}, {
						name: '每月',
						val: '02'
					}, {
						name: '单次任务(完成一次目标即可)',
						val: '03'
					}],
					memberaction: [{
						name: '成员报名参加',
						val: '00'
					}, {
						name: '全员参加',
						val: '01'
					}, {
						name: '指定成员参加',
						val: '02'
					}],
					activeNames: 0,
					isSubmit: false,
					endTimeShow: false,
					endTimeColumns: [],
					form: JSON.parse(localStorage.getItem('taskForm2')) || {
						zq: "选择任务周期",
						cy: "选择指定成员",
						zq2: '',
						zq2title: ''
					},
					submitform: JSON.parse(localStorage.getItem('taskForm')) || {
						"clubId": "",
						"name": "",
						"label": "00", //00跳绳
						"period": "", //(00每天,01每周,02每月,03单次任务)
						"target": "",
						"assignType": "", //(00成员报名参加,01全员参加,02指定成员参加)
						"introduce": "", //任务说明
						"creator": "", //创建者
					},
					currentDate: new Date(),
					minDate: null,
					zq2show: false,
					chooseMonth:null,
					choosetime:null,
					dayArr:[],
				}
			},
			created() {
				if (isIOS) {
					// localStorage.setItem("chooseMemberList", "");
					// localStorage.setItem("chooseGroup", "");
				}
				if (this.iscorporate == 1) {
					//如果是企业的
					this.memberaction = [{
						name: '全员参加',
						val: '01'
					}, {
						name: '指定部门参加',
						val: '03'
					}, {
						name: '指定成员参加',
						val: '02'
					}];
					this.timeaction = [{
						name: '每天（每天完成一次目标）',
						val: '00'
					}, {
						name: '周任务',
						val: '01'
					}, {
						name: '月任务',
						val: '02'
					}]
				}
				var date = DateTime.timeStamp2String("md2");
				var date2 = DateTime.timeStamp2String("ymd");
				this.endTimeColumns.push(date)
				var todaySJC = DateTime.getSjc(date2);
				for (var i = 1; i < 30; i++) {
					this.endTimeColumns.push(DateTime.sjc2time("md2", (todaySJC + 86400000 * i)))
				}
			},
			methods: {
				formatter(type, val) {
					if (type === 'year') {
						return val + '年';
					}
					if (type === 'month') {
						return val + '月';
					}
					if (type === 'day') {
						return val + (this.dayArr.length==0?'日':'');
					}
					return val;
				},
				filter(type, options) {
					let datetime = new Date().getTime();
					if (type == 'year' || type == 'month') {
						return options;
					}
					if (type == 'day') {
						let arr = [];
						if (this.submitform.period == '00') { //按日不动
							return options;
						} else if (this.submitform.period == '01') { //按周
							if(this.dayArr.length>0){
								return this.dayArr
							}
							for (let i = 0; i < 10; i++) {
								// console.log(DateTime.sjc2time("ymd", datetime+(86400000*7)*(i+1)))
								if(DateTime.sjc2time("M", datetime+(86400000*7)*(i+1)) == DateTime.sjc2time("M", datetime)){
									arr.push(DateTime.sjc2time("d", datetime+(86400000*7)*(i+1))+'')
								}
							}
							console.log(1234)
							return arr;
						} else {
							if(this.dayArr.length>0){
								return this.dayArr
							}
							arr.push(options[0])
							return arr;
						}
					}
				},
				zq2change(event) {
					if (this.submitform.period == '00'){return}
					let dateArr = event.getValues();
					let month = parseInt(dateArr[1].replace(/月/,''));
					let mindateM = DateTime.sjc2time("M", this.minDate.getTime());
					// if(month == mindateM){//判断是否选中的月份是当前月份，如果是就直接返回
					// 	// event.setColumnValue(2,dateArr[2]);
					// 	return;
					// }
					if(month == this.chooseMonth&&this.submitform.period == '01'){
						console.log(this.dayArr)
						event.setColumnValue(2,this.dayArr);
						return;
					}
					var nowChoose = dateArr[0].replace(/年/,'')+'-'+month+'-'+ dateArr[2].replace(/日/,'');
					nowChoose = new Date(nowChoose).getTime();
					let arr = [];
					if (this.submitform.period == '01') {//按周
						for (let i = 0; i < 100; i++) {
							if(DateTime.sjc2time("M", this.minDate.getTime()+(86400000*7)*(i+1)) == DateTime.sjc2time("M", nowChoose)){
								arr.push(DateTime.sjc2time("d", this.minDate.getTime()+(86400000*7)*(i+1))+'日')
							}
							if(DateTime.sjc2time("M", this.minDate.getTime()+(86400000*7)*(i+1)) > DateTime.sjc2time("M", nowChoose)){
								break;
							}
						}
						
					} else if (this.submitform.period == '02') {//按月
						for (let i = 0; i < 100; i++) {
							if(DateTime.sjc2time("M", this.minDate.getTime()+(86400000*30)*(i+1)) == DateTime.sjc2time("M", nowChoose)){
								arr.push(DateTime.sjc2time("d", this.minDate.getTime()+(86400000*30)*(i+1))+'日')
							}
							if(DateTime.sjc2time("M", this.minDate.getTime()+(86400000*30)*(i+1)) > DateTime.sjc2time("M", nowChoose)){
								break;
							}
						}
					}
					console.log(arr)
					event.setColumnValues(2,arr);
					event.setColumnValue(2,event.getColumnValues(2)[0]);
					this.dayArr = arr;
					console.log(event.getValues())
					let choosetimearr = event.getValues();
					this.choosetime = new Date(choosetimearr[0].replace(/年/,'')+'-'+choosetimearr[1].replace(/月/,'')+'-'+ choosetimearr[2].replace(/日/,'')).getTime();
					this.chooseMonth = month;
				},
				zq2confirm(value) {
					console.log(value)
					if (this.submitform.period == '00') {
						this.form.zq2 = DateTime.sjc2time("md3", new Date(value).getTime());
					}else{
						this.form.zq2 =DateTime.sjc2time("md3", new Date().getTime()) +'-'+ DateTime.sjc2time("md3", new Date(value).getTime());
					}
					this.submitform.taskEndTimestamp = new Date(value).getTime();
					this.zq2show = false;
				},
				onSelectTime(obj, index) { //任务周期回调
					if (this.iscorporate == 1) {
						this.submitform.period = obj.val;
						this.form.zq2 ="";
						this.submitform.taskEndTimestamp = null;
						this.form.zq = obj.name;
						if (obj.val == '00') {
							this.form.zq2title = '日任务截止时间';
							this.minDate = this.currentDate;
							this.form.zq2 = DateTime.sjc2time("md3", this.currentDate.getTime());
						} else if (obj.val == '01') {
							this.form.zq2title = '周任务时间';
							this.minDate = new Date(this.currentDate.getTime()+86400000*7);
							this.zq2confirm(new Date(this.currentDate.getTime()+86400000*7))
						} else {
							this.form.zq2title = '月任务时间';
							this.minDate = new Date(this.currentDate.getTime()+86400000*30);
							this.zq2confirm(new Date(this.currentDate.getTime()+86400000*30))
						}
					} else {
						this.periodClick(obj.val, obj.name)
					}

				},
				onSelectMember(obj, index) { //选择成员回调
					this.submitform.assignType = obj.val;
					this.form.cy = obj.name;
					if (obj.val == '02') {
						this.chooseMemberList();
					}
					if (obj.val == '03') {
						localStorage.setItem("taskForm", JSON.stringify(this.submitform));
						localStorage.setItem("taskForm2", JSON.stringify(this.form));
						window.location.href = '../corporateClub/chooseGroup.html?id=' + this.submitform.clubId +
							"&hideTitle=1";
					}
				},
				periodClick(value, str) {
					this.submitform.period = value;
					this.form.zq = str;
					this.activeNames = 0;
					this.submitform.taskStartTimestamp = "";
					this.submitform.taskEndTimestamp = "";
					if (value == '00') {
						this.submitform.taskStartTimestamp = null;
						this.submitform.taskEndTimestamp = null;
					} else if (value == '01') {
						this.submitform.taskStartTimestamp = getNextMonday();
						this.submitform.taskEndTimestamp = null;
					} else if (value == '02') {
						this.submitform.taskStartTimestamp = getMonthTimeStamp();
						this.submitform.taskEndTimestamp = null;
					} else if (value == '03') {
						this.endTimeShow = true;
						this.submitform.taskStartTimestamp = null;
						this.submitform.taskEndTimestamp = null;
					}
				},
				//单次任务选择时间后回调
				onendTimeConfirm(value, index) {
					this.submitform.taskStartTimestamp = null;
					this.submitform.taskEndTimestamp = "";
					var date2 = DateTime.timeStamp2String("ymd");
					var todaySJC = DateTime.getSjc(date2);
					var endSJC = todaySJC + (index + 1) * 86400000;
					this.submitform.taskEndTimestamp = endSJC;
					this.form.zq = "单次任务(" + value + "前)"
					this.endTimeShow = false;
				},
				submitFormData() {
					var _self = this;
					if (_self.isClick) {
						return;
					}
					_self.isClick = true
					this.isSubmit = true;
					this.submitform.creator = JSON.parse(localStorage.getItem("appInfo")).userId;
					for (var key in this.submitform) {
						console.log(key + ":" + this.submitform[key]);
						if (this.submitform[key] === "") {
							_self.isClick = false;
							return;
						}
					}
					if (this.submitform.period == '03' && !this.submitform.taskEndTimestamp) {
						_self.isClick = false;
						this.$toast("请选择任务的截止时间!");
						return
					}
					this.submitform.target = parseInt(this.submitform.target);
					if (this.submitform.target > 1000000) {
						this.$toast("任务目标不大于一百万!");
						this.submitform.target = "";
						_self.isClick = false;
						return
					}
					if (this.submitform.target < 1) {
						this.$toast("任务目标不可小于1!");
						this.submitform.target = "";
						_self.isClick = false;
						return
					}

					if (this.submitform.assignType == "02") {
						if (!localStorage.getItem("chooseMemberList")) {
							_self.$toast("请先选择俱乐部成员!");
							_self.isClick = false;
							return;
						} else {
							this.submitform.memberIdList = localStorage.getItem("chooseMemberList").split(",");
						}
					} else {
						this.submitform.memberIdList = [];
					}
					if (this.submitform.assignType == "03") {
						if (!localStorage.getItem("chooseGroup")) {
							_self.$toast("请先选择部门!");
							_self.isClick = false;
							return;
						} else {
							this.submitform.clubGroupIdList = localStorage.getItem("chooseGroup").split(",");
							this.submitform.clubGroupIdList.forEach((d, i) => {
								if (d == 'wfb') this.submitform.clubGroupIdList[i] = ''
							})
						}
					} else {
						this.submitform.clubGroupIdList = [];
					}
					ajax({
						type: "post",
						url: "club/saveTask",
						data: this.submitform,
						success: function(res) {
							if (res.code == 0) {
								_self.$toast("任务创建成功！");
								localStorage.removeItem('taskForm');
								localStorage.removeItem('taskForm2');
								localStorage.setItem("chooseMemberList", "");
								localStorage.setItem("chooseGroup", "");
								_self.gotoDetail(res.data.taskId);
								// _self.createNotice(res.data.taskId);

							} else if (res.code == 4003) {
								_self.isClick = false;
								if (_self.submitform.period == "00") {
									_self.$toast("每日任务最多可同时创建3个");
								} else if (_self.submitform.period == "01") {
									_self.$toast("每周任务最多可同时创建1个");
								} else if (_self.submitform.period == "02") {
									_self.$toast("每月任务最多可同时创建1个");
								}
								localStorage.setItem("chooseMemberList", "");
								localStorage.setItem("chooseGroup", "");
							} else if (res.code == 3000) {
								_self.isClick = false;
								_self.$toast("任务名已经存在");
							} else if (res.code == 4001) {
								_self.isClick = false;
								_self.$toast("文本内容违规");
							} else {
								_self.isClick = false;
								_self.$toast(res.msg);
							}
						},
						error: function() {
							_self.isClick = false;
							console.log("error")
						}
					})
				},
				chooseMemberList() {
					localStorage.setItem("taskForm", JSON.stringify(this.submitform));
					localStorage.setItem("taskForm2", JSON.stringify(this.form));
					// this.submitform.assignType = '02';
					this.form.cy = '指定成员参加';
					if (this.iscorporate == 1) {
						//企业
						window.location.href = '../corporateClub/groupMember.html?clubId=' + this.submitform.clubId +
							"&hiddenTitle=1&fromchoose=7";
					} else {
						this.activeNames = 0;
						window.location.href = 'chooseMemberList.html?id=' + this.submitform.clubId +
							"&hiddenTitle=1";
					}

					// if (/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)) { //判断iPhone|iPad|iPod|iOS{}else{
					// 	var str = '/h5/h5V2/allClub/club/chooseMemberList.html?id='+this.submitform.clubId+"&hiddenTitle=1";
					// 	Interaction.pushToNextVC(str)
					// } else {
					// 	var str = host+'h5/h5V2/allClub/club/chooseMemberList.html?id='+this.submitform.clubId+"&hideTitle=1";
					// 	Interaction.pushToNextVC(str)
					// }

				},
				createNotice(taskId) {
					var _self = this;
					ajax({
						type: "post",
						url: "club/saveClubNotice",
						data: {
							title: "有新的任务," + _self.form.zq + "跳绳" + _self.submitform.target + "个",
							content: "有新的任务," + _self.submitform.introduce,
							clubId: _self.submitform.clubId,
							type: "00",
							relatedId: taskId
						},
						success: function(res) {
							if (res.code == 0) {
								_self.gotoDetail(taskId);
							} else {
								_self.$toast(res.msg);
							}
						},
						error: function() {
							console.log("error")
						}
					})
				},
				gotoDetail(taskId) {
					var _self = this;
					if (/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)) { //判断iPhone|iPad|iPod|iOS
						try {
							//IOS 调用方法，H5去任务详情界面，拿到任务ID，任务设置做：发任务通知、结束任务、停止报名操作使用
							window.webkit.messageHandlers.lstNative.postMessage({
								'method': 'clubToTaskDetail',
								'taskId': taskId,
								"url": "/h5/h5V2/allClub/club/tasksDetail.html?id=" + taskId + '&userId=' +
									JSON.parse(localStorage.getItem(
										"appInfo")).userId + '&clubId=' + _self.submitform.clubId
							})

						} catch (err) {
							console.log('window.webkit.messageHandlers 回传Id failed')
						}

					} else if (/(Android)/i.test(navigator.userAgent)) { //判断Android
						var str = 'taskId=' + taskId;
						window.android.clubToTaskDetail(str);
						window.location.href = "tasksDetail.html?id=" + taskId + '&clubId=' + _self.submitform.clubId
					}
					//this.isClick = false;

				},
				titleChange() {
					this.submitform.name = this.submitform.name.replace(
						/[^\u4E00-\u9FA5|\d|\a-zA-Z|\r\n\s,.?!，。#￥$%\`~^？！@…—&$=()\-+\/*{}【】\\（）[\]]|\s/g, '')
				},
				contentChange() {
					this.submitform.introduce = this.submitform.introduce.replace(
						/[^\u4E00-\u9FA5|\d|\a-zA-Z|\r\n\s,.?!，。#￥$%\`~^？！@…—&$=()\-+\/*{}【】\\（）[\]]|\s/g, '')
				},
				targeChange() {
					this.submitform.target = this.submitform.target.replace(/[^0-9]\d*/, '')
				}
			}
		})
	</script>
</html>
