<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
    <link rel="stylesheet" href="https://oss.laisitech.com/ccd1029d-8dd1-442a-94a7-5205ee2ff9f5.css">
    <link rel="stylesheet" href="font/iconfont.css">
    <link rel="stylesheet" type="text/css" href="css/common.css" />
    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <link rel="stylesheet" href="font/iconfont.css">
    <script src="https://lsprod3.laisitech.com/h5/h5V3/common/js/vue.js"></script>
    <script src="https://lsprod3.laisitech.com/h5/h5V3/common/js/vant.js"></script>
    <script src="../common/js/network.js"></script>
    <script src="js/openId.js"></script>
    <title>静安区亲子跳绳挑战赛</title>
    <style type="text/css">
        body,
        .page {
            background-color: #E5F2FB;
        }
    </style>

</head>

<body>
    <div id="app" class="page" v-cloak>
        <div class="header">
            <van-nav-bar title="静安区亲子跳绳挑战赛" @click-left="closeH5()" @click-right="share" safe-area-inset-top fixed>
                <template #left v-if="!isShare">
						<span class="icon iconfont icon-fanhuianniu" style="font-size: 0.5rem;" ></span>
					</template>
                <template #right v-if="!isShare">
						<span class="icon iconfont icon-fenxianganniu"  style="font-size: 0.5rem;"></span>
					</template>
            </van-nav-bar>
        </div>
        <van-pull-refresh v-model="refreshing" @refresh="onRefresh">
            <div>
                <div class="pageBgBox">
                    <img class="ruleicon" src="img/ruleindex.png" @click="window.location.href='rule.html'" alt="">
                    <!-- <img src="img/PKicon.png" class="gotoSchoolBtn" @click="gotoSchool" alt=""> -->
                    <div v-if="!isShare&&!djs" class="gojump" @click="listShow = true">去跳绳 <span v-if="djs">{{djs}} </span></div>
                    <div v-if="!isShare&&djs" class="gojump" v-if="djs">去跳绳 <span v-if="djs">{{djs}} </span></div>
                </div>
                <div class="contain">
                    <div id="infobox" class="">
                        <div class="card card-person" style="min-height:2.2rem;">
                            <div class="schoolName">
                                <div>{{person.studentSchoolInfo.schoolName}}</div>
                            </div>
                            <div class="studentName">
                                {{person.studentSchoolInfo.name}}
                            </div>
                            <div class="studentInfoBox">
                                学籍号：{{person.studentSchoolInfo.studentCardId}}
                            </div>
                            <div class="studentInfoBox">
                                年 &nbsp 级：{{person.studentSchoolInfo.grade}}
                            </div>
                        </div>
                        <div class="ub ub-pj ub-ac">
                            <div class="card ub-f1 card-camp" @click="gonext(1)" style="margin-right: .18rem;">
                                <div class="cardTitle">
                                    倒计时1min区排名
                                </div>
                                <div class="ranking">
                                    {{person.oneRank||"--"}}
                                </div>
                                <div class="circle">
                                    <img src="img/circlecamp.png">
                                </div>
                            </div>
                            <div class="card ub-f1 card-school" @click="gonext(2)" style="padding-left: .3rem;">
                                <div class="cardTitle">
                                    学校区排名
                                </div>
                                <div class="ranking">
                                    {{person.schoolRank||"--"}}
                                </div>
                                <div class="circle">
                                    <img src="img/circleschool.png">
                                </div>
                            </div>
                        </div>
                        <div class="card card-parent" @click="gonext(3)">
                            <div class="cardTitle">
                                倒计时3+3分钟区排名（家长+学生）
                            </div>
                            <div class="ranking">
                                {{person.threeRank||"--"}}
                            </div>
                            <div class="circle">
                                <img src="img/circleparent.png">
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </van-pull-refresh>


        <van-popup v-model="listShow" round position="bottom">
            <div class="competitionListBox">
                <div v-for="item in person.competitonInfos" class="itemBox" @click="gotoSkip2(item.competitionId)">
                    <div class="name van-ellipsis">{{item.competitionName}}</div>
                    <div class="status">
                        <!-- sdfsdfsdfds -->
                        <span class="iconfont icon-tongyong-gengduo" />
                    </div>
                </div>
            </div>
        </van-popup>


        <van-dialog v-model="unbindShow" width="280px" cancel-button-color="#222" confirm-button-color="#222" confirm-button-text="去绑定" title="请先绑定跳绳设备" @confirm="confirm" show-cancel-button>
        </van-dialog>
    </div>
</body>
<script>
    var vm;
    var isPageHide = false;
    window.addEventListener('pageshow', function() {
        if (isPageHide && isIOS) {
            //vm.init()
        }
    });
    window.addEventListener('pagehide', function() {
        isPageHide = true;
    });
    new Vue({
        el: '#app',
        data() {
            return {
                campId: getQueryString('campId') || "jingan20220124",
                refreshing: false,
                isShare: getQueryString('isShare'),
                person: {
                    studentSchoolInfo: {},
                    competitonInfos: [],
                    rankInfo: {}
                },
                rankIng: {
                    homePageStudentRanking: 0,
                    homePageScoolRanking: 0,
                    homePageSchoolId: 15
                },
                listShow: false,
                unbindShow: false,
                interval: "",
                djs: ""
            };
        },
        watch: {},
        filters: {},
        mounted() {
            window.initCompetitionDetail = this.initCompetitionDetail;
        },
        created() {
            var that = this;
            if (isWechat) { //说明是分享的页面
                if (getCookie('SUMMERCAMP_OPENID')) {
                    that.openId = getCookie('SUMMERCAMP_OPENID');
                } else {
                    if (getCode()) {
                        //页面中带有code调用接口获取openId
                        getOpenid(getCode(), function(openid) {
                            if (!openid) return;
                            that.openId = openid;
                        })
                    } else { //重定向
                        var local = location.href;
                        window.location.href = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' + APPID + '&redirect_uri=' +
                            encodeURIComponent(local) + '&response_type=code&scope=snsapi_base&state=#wechat_redirect'
                    }
                }
            }
            this.initCompetitionDetail();
        },
        methods: {
            onRefresh() {
                this.initCompetitionDetail();
                this.refreshing = false;
            },
            initCompetitionDetail() { //获取个人信息
                ajax({
                    url: "summerVlogSkippingPk/homePage/myHomePage",
                    data: {
                        campId: this.campId
                    }
                }).then(res => {
                    if (res.code == 0) {
                        this.person = Object.assign({
                            studentSchoolInfo: {},
                            schoolName: "",
                            grade: "",
                            studentCardId: ""
                        }, res.data);

                        if ((res.data.startTime - new Date().getTime()) > 0) {
                            this.interval = setInterval(() => {
                                var s = parseInt((res.data.startTime - new Date().getTime()) / 1000)
                                if (s <= 0) {
                                    clearInterval(this.interval)
                                    this.initCompetitionDetail()
                                }
                                var hour = Math.floor(s / 3600) + "";
                                var minute = Math.floor((s - hour * 3600) / 60) + "";
                                var second = s - hour * 3600 - minute * 60 + "";
                                this.djs = hour.padStart(2, "0") + ":" + minute.padStart(2, "0") + ":" + second.padStart(2, "0");
                            }, 1000);
                        }

                    } else {
                        this.$toast(res.msg)
                    }
                })

            },
            closeH5() {
                Interaction.closePage()
            },
            // gotoSkip() {
            //     ajax({
            //         url: "device/get/bound/device",
            //     }).then((res) => {
            //         let unbind = true;
            //         if (res.code == 0) {
            //             res.data.forEach((item) => {
            //                 if (item.deviceType == "skipping") {
            //                     this.listShow = true;
            //                     this.unbindShow = false;
            //                     unbind = false
            //                     return;
            //                 }
            //             });
            //             if (unbind) {
            //                 this.unbindShow = true
            //             }
            //         } else if (res.code == 1000) {
            //             this.unbindShow = true
            //         } else {
            //             this.$toast(res.msg)
            //         }
            //     });
            // },
            gotoSkip2(competitionId) {
                ajax({
                    url: "summerVlogSkippingPk/vlogStory/get/now/round/times",
                    data: {
                        competitionId: competitionId,
                        campId: this.campId
                    }
                }).then((res) => {
                    if (res.code == 0) {
                        this.listShow = false;
                        this.gotoSkip3(res.data)
                    } else {
                        this.$toast(res.msg)
                    }
                });
            },
            gotoSkip3(obj) {
                if (obj.roundTimes <= 0) {
                    this.$toast("您今天的跳绳次数已经用完，请明天继续！")
                    return
                }
                var skipItem = {
                    method: "LSTH5APP_JingAnSchoolChallenge", //H5调起原生选择设备，需要过滤掉rs-s3，Hilink，发光跳绳，并跳转到专门的vlog页面，
                    isChild: obj.isChild, // 1是学生，0是家长 int
                    competitionId: obj.competitionId + "", // 比赛ID string
                    roundTimes: obj.roundTimes, // 跳了多少次 int
                    skipTime: obj.skipTime, //倒计时长， 秒 int
                    campId: this.campId
                }
                if (isIOS) {
                    window.webkit.messageHandlers.lstNative.postMessage(skipItem)
                } else { //判断Android
                    window.android.LSTH5APP_JingAnSchoolChallenge(JSON.stringify(skipItem));
                }
            },
            gonext(type) {
                var url = ""
                if (type == 1) {
                    this.person.competitonInfos.forEach(item => {
                        if (item.modeValue == 60) {
                            url = `personalRanking.html?competitionId=${item.competitionId}&fromH5=1&shareName=${this.person.studentSchoolInfo.name}`
                        }
                    });
                } else if (type == 2) {
                    url = `schoolRanking.html?fromH5=1&shareName=${this.person.studentSchoolInfo.schoolName}`

                } else if (type == 3) {
                    this.person.competitonInfos.forEach(item => {
                        if (item.modeValue == 180) {
                            url = `parentRanking.html?competitionId=${item.competitionId}&fromH5=1&shareName=${this.person.studentSchoolInfo.name}`
                        }
                    });
                }
                if (this.isShare) {
                    url += `&isShare=1&campId=${this.campId}`
                } else {
                    url += `&campId=${this.campId}`
                }
                window.location.href = url
            },
            share() {
                Interaction.sharePage({
                    "title": `${this.person.studentSchoolInfo.schoolName}在参加静安区跳绳争霸赛`,
                    "description": "来给我投票呀!",
                    "url": host + `h5/h5V3/summercamp/index.html?isShare=1&userId=${JSON.parse(localStorage.getItem("appInfo")).userId}&campId=${this.campId}`
                })
            },
            confirm() {
                if (isIOS) {
                    window.webkit.messageHandlers.lstNative.postMessage({
                        method: "LSH5APP_Push_Action",
                        actionType: "LSTH5APP_GoMyDeviceVC",
                        actionNum: "0900",
                        isEffective: 0,
                    });

                } else if (isAndroid) {
                    window.android.LSH5APP_Push_Action(JSON.stringify({
                        actionType: "LSTH5APP_GoMyDeviceVC",
                        actionNum: "0900",
                        isEffective: 0,
                    }))
                }
            },

        },
    });
</script>

</html>