<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
    <!-- <title>历史周报</title> -->
    <link rel="stylesheet" href="https://oss.laisitech.com/ccd1029d-8dd1-442a-94a7-5205ee2ff9f5.css">
    <link rel="stylesheet" href="font/iconfont.css">
    <link rel="stylesheet" id="themeCssLink" href="../common/css/default.css">
    <link rel="stylesheet" href="css/index.css">

</head>

<body>
    <div id="app" v-cloak>
        <div id="app" class="normalHeader" v-cloak>
            <div class="header">
                <van-nav-bar @click-left="onclickLeft" :title="type==1?'历史周报':'历史月报'" left-arrow safe-area-inset-top fixed>
                    <template #left>
                        <span class="icon iconfont icon-fanhuianniu" style="font-size: 0.5rem;" />
                    </template>

                </van-nav-bar>
            </div>
            <div class=" historyListBox" v-if="type==1">
                <div class="historyListDiv" v-for="item in weekList">
                    <div v-for="item2 in item.data">
                        <div class="title">{{item.name+'年'+item2.name+'月'}}</div>
                        <div class="itemList">
                            <div class="itemTitle" v-for="item3 in item2.data" @click="goReport(item3)">
                                {{item3.startDateTime+'-'+item3.endDateTime}}
                                <span class="icon iconfont icon-tongyong-gengduo" style="font-size: 0.35rem;"></span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="main-contain historyListBox" v-else>
                <div class="historyListDiv" v-for="item in monthList">

                    <div class="title">{{item.name+'年'}}</div>
                    <div class="itemList">
                        <div class="itemTitle" v-for="item2 in item.data" @click="goReport(item2)">
                            {{item2.startDateTime}}
                            <span class="icon iconfont icon-tongyong-gengduo" style="font-size: 0.35rem;"></span>
                        </div>
                    </div>
                </div>

            </div>

        </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/vant@2.12/lib/vant.min.js"></script>
<script src="../common/js/network.js"></script>
<script>
    new Vue({
        el: '#app',
        data() {
            return {
                minDate: "2021-09-01",
                weekList: [],
                monthList: [],
                type: getQueryString("type"), //1 week 2 month

            };
        },
        filters: {

        },
        created() {

        },
        mounted() {
            if (this.type == 1) {
                this.getWeekList()
            } else {
                this.getMonthList()
            }


        },
        methods: {
            onclickLeft() {
                window.history.back(-1)
            },
            goReport(item) {
                console.log(item)
                localStorage.setItem("report_startTime", item.startTime)
                localStorage.setItem("report_endTime", item.endTime)
                window.history.go(-1);
            },

            getWeekList() {
                let minDateTime = new Date(this.minDate).getTime();
                let nowDateTime = new Date().getTime();
                let weekList = []

                lastWeek(nowDateTime)

                function lastWeek(value) {
                    let weekItem = {};
                    if (value == '' || value == undefined) {
                        return value
                    }
                    if (value.length == 10) {
                        value = value * 1000
                    }
                    let myDate = new Date(value - 7 * 24 * 3600 * 1000)
                    let day = myDate.getDay() // 回退7天后是星期几？

                    let time = myDate.getDate() - day + (day === 0 ? -6 : 1)
                    let startTime = new Date(new Date(value - 7 * 24 * 3600 * 1000).setDate(time))
                    let startDateTime =
                        // startTime.getFullYear() +
                        // '-' +
                        (startTime.getMonth() + 1) +
                        '月' +
                        startTime.getDate() +
                        '日'
                    let startDateTime2 = (startTime.getFullYear()) + "-" + (startTime.getMonth() + 1).toString().padStart(2, "00") + '-' +
                        startTime
                        .getDate().toString().padStart(2, "00")

                    let endTime = new Date(new Date(value - 7 * 24 * 3600 * 1000).setDate(time + 6))
                    let endDateTime =
                        // endTime.getFullYear() +
                        // '-' +
                        (endTime.getMonth() + 1) +
                        '月' +
                        endTime.getDate() +
                        '日'
                    let endDateTime2 = (endTime.getFullYear()) + "-" + (endTime.getMonth() + 1).toString().padStart(2, "00") + '-' + endTime
                        .getDate().toString().padStart(2, "00")

                    weekItem.startDateTime = startDateTime;
                    weekItem.endDateTime = endDateTime;
                    weekItem.year = endTime.getFullYear();
                    weekItem.month = endTime.getMonth() + 1;
                    weekItem.startTime = new Date(startDateTime2).getTime(),
                        weekItem.endTime = new Date(endDateTime2).getTime(),

                        weekList.push(weekItem);

                    if (startTime.getTime() > minDateTime) {
                        lastWeek(startTime.getTime())
                    }

                }

                //按照年分好
                this.weekList = this.groupByType(weekList, "year")
                    //按照月分类
                this.weekList.forEach(item => {
                    item.data = this.groupByType(item.data, "month")
                });
                console.log(this.weekList)

            },
            groupByType(arr, param) {
                var map = {},
                    dest = [];
                for (var i = 0; i < arr.length; i++) {
                    var ai = arr[i];
                    if (ai[param] && !map[ai[param]]) {
                        dest.push({
                            name: ai[param],
                            data: [ai]
                        });
                        map[ai[param]] = ai;
                    } else {
                        for (var j = 0; j < dest.length; j++) {
                            var dj = dest[j];
                            if (dj.name == ai[param]) {
                                dj.data.push(ai);
                                break;
                            }
                        }
                    }
                }
                return dest;
            },


            getMonthList(value) {
                let minDateTime = new Date(this.minDate).getTime();
                let nowDateTime = new Date().getTime();
                let monthList = []

                lastMonth(nowDateTime)

                function lastMonth(value) {
                    let monthItem = {};
                    if (value == '' || value == undefined) {
                        return value
                    }
                    if (value.length == 10) {
                        value = value * 1000
                    }
                    // 获取上个月时间
                    let nowdays = new Date(value)
                    let year = nowdays.getFullYear()
                    let month = nowdays.getMonth()
                    if (month === 0) {
                        month = 12
                        year = year - 1
                    }
                    if (month < 10) {
                        month = '0' + month
                    }

                    let yDate = new Date(year, month, 0)

                    startDateTime = year + '年' + month + '月' //上个月第一天
                    endDateTime = year + '年' + month + '月' + yDate.getDate() //上个月最后一天

                    monthItem.startDateTime = startDateTime;
                    monthItem.endDateTime = endDateTime;
                    monthItem.year = year;

                    monthItem.startTime = new Date(year + '-' + month + '-' + "01").getTime(),
                        monthItem.endTime = new Date(year + '-' + month + '-' + yDate.getDate().toString().padStart(2, "00")).getTime(),

                        monthList.push(monthItem);

                    if (new Date(endDateTime).getTime() > minDateTime) {
                        lastMonth(new Date(endDateTime).getTime())
                    }
                }
                this.monthList = this.groupByType(monthList, "year")
            },

        }
    })
</script>

</html>