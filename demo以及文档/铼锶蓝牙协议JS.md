# 铼锶蓝牙协议JS（V0.1）

## 1. utils（全局变量）
```
    host: "https://lsprod3.laisitech.com/",//请求头
    appId: "129836372101",//铼锶分配的appId
    appSecret: "Tp64DuQ6CQqHeTSHfzbJKusHu4K0Piab",//铼锶分配的appSecret
    sequenceIDcofig: "00",//指令发送时持续累加
    commandHeader: "",//指令接收时暂存的指令头部
    fullCommand: "",//最终的完整指令
    commandList: {//命令对应的说明
        "01": {
            "01": "举例说明，未使用",
            "02": "设置RTC时间",
            "03": "确认历史记录同步成功",
            "04": "开始跳绳",
            "05": "停止跳绳",
            "06": "呼叫设备",
            "07": "重启设备进入FOTA模式",
            "08": "设置双三摇开关",
            "09": "设置发光跳绳发光模式、颜色、亮度、频次",
        },
        "02": {
            "01": "读取设备固件版本号",
            "04": "读取设备RTC时间",
            "05": "读取设备电量",
            "07": "读取设备当前跳绳状态",
            "08": "获取鉴权随机码",
            "09": "获取客户代码",
            "0A": "获取双三摇开关",
            "0B": "获取功能配置项",
            "0C": "获取发光跳绳发光模式颜色、亮度、频次"
        },
        "03": {
            "01": "鉴权"
        },
        "04": {
            "01": "同步历史数据"
        }
    }
```
---
## 2. tool（工具类）
```
- hexToArr //十六进制字符串转数组（2个一组）
- hexToArr2 //十六进制字符串转数组（8个一组）
- numToHex // 十进制转十六进制
- sumCheck //TL1 Payload 段所有数据无进位累加和
- hexStringToArrayBuffer //String类型的数据转为ArrayBuffer
- arrayBufferToHex //Arraybuffer To hex
- StrToBytes //十六进制字符串转字节数组
- md5 //MD5加密方法
```
---
## 3. bp（指令处理类）
- #### getAuth

    #### 说明：通过接口请求从laisi获取鉴权码
    #### 参数：
    | 属性 | 类型 | 默认 | 必填 | 说明 | 示例 
    | :-----| :----: | :----: | :----: | :----: | :----: |
    | mac |String||是|当前连接的设备的蓝牙地址|BC:97:40:51:90:A3
    | sn |String||是|当前连接的设备对应的sn|LTA302053C00395
    | random |Number||是|鉴权命令发送之后，蓝牙设备返回随机数（需要转为10进制）|4294907099
    #### 返回值：
    | 属性 | 类型   | 说明 | 示例 
    | :-----| :----: | :----: | :----: | :----: | :----: |
    | code |Int|标识码|0
    | data |Number|随机数 |184964417
    | msg |String|解释说明|success


- ### commandAssemble
   #### 说明：设置及读取跳绳的指令组装
   #### 参数(Object对象)
    | 属性 | 类型 | 默认 | 必填 | 说明 | 示例 
    | :-----| :----: | :----: | :----: | :----: | :----: |
    | command |String||是|指令Command （设置类：01，读取类：02，鉴权：03，同步：04 ）|02
    | key |String||是|指令key（详见全局变量utils的commandList）|01
    | requestCommand |Object||否|指令所需的参数值|{mode:2,modeValue:100}

    ##### requestCommand对象所需的参数值（根据command和key）：

    > 鉴权 command:03  key:01
    
    | 属性 | 类型 | 默认 | 必填 | 说明 | 示例 
    | :-----| :----: | :----: | :----: | :----: | :----: |
    | random |Number||是|设备返回的鉴权码|23248216
    
    > 设置RTC时间 command:01  key:02
    
    | 属性 | 类型 | 默认 | 必填 | 说明 | 示例 
    | :-----| :----: | :----: | :----: | :----: | :----: |
    | timestamps |Number||是|需要设置的时间戳|1641366097000
    
    > 开始跳绳 command:01  key:04
    
    | 属性 | 类型 | 默认 | 必填 | 说明 | 示例 
    | :-----| :----: | :----: | :----: | :----: | :----: |
    | mode |Int||是|跳绳模式：1-自由跳2-倒计时跳3-倒计数跳|2
    | modeValue |Int||是|跳绳模式值：如果是倒计时跳，就是跳多少秒；如果是倒计数跳，就是跳多少个|100
    | dataType |Int|0|否|跳绳类别：0:一般模式，跳绳过程中可以切换跳绳模式非0: 防作弊模式，跳绳过程中不能切换模式及复位该位置没有值时请传0|0
    | skipId |Int|0|否|跳绳数据ID：用于对跳绳数据进行分类，供后台数据分类使用。该位置没有值时请传0|0
    
    > 设置双三摇开关 command:01  key:08
    
    | 属性 | 类型 | 默认 | 必填 | 说明 | 示例 
    | :-----| :----: | :----: | :----: | :----: | :----: |
    | tripleJumpSwitch |Int|0|否|开关值|1
    
    > 设置发光跳绳发光模、颜色、亮度、频次 command:01  key:09
    
    | 属性 | 类型 | 默认 | 必填 | 说明 | 示例 
    | :-----| :----: | :----: | :----: | :----: | :----: |
    | lightMode |Int||是|发光模式：1：单色常亮2：单色呼吸 3：多色渐变 4：BPM模式|1
    | brightness |Int||是|频次：1慢，2正常，3快|1
    | rate |Int||是|频次|1
    | colorList |Array||是| 颜色数组:发光模式1和2，只跟3个字节分别是RGB。模式3至少是2个RGB，最多7个RGB。|[255,255,1]
    
    颜色说明：
    发光模式为单色常亮1和单色呼吸2时，颜色值三个字节：分别是RGB。
    发光模式为多色渐变3时，至少有2个RGB6个字节，最多有7个RGB21个字节的颜色值。
    发光模式为BPM模式4时，颜色值不用关注，频次不用关注，只需关注 亮度。
    频次说明：
    发光模式为单色常亮1和BPM模式4时，不用关注频次
    亮度的值分别为：1暗，2正常，3亮
    频次的值分别为：1慢，2正常，3快
    colorList说明 按照数组顺序分别对应R、G、B的色值

    #### 返回值：
    | 属性 | 类型   | 说明 | 示例 
    | :-----| :----: | :----: | :----: | :----: | :----: |
    | code |Int|标识码（0:正常，-1：错误）|0
    | data |Buffer|指令组装之后，可直接发送给蓝牙设备的16进制buffer数据 |184964417
    | msg |String|解释说明|success

- ### commandAnalysis
  #### 说明：设置及读取跳绳的指令解析,将从设备收到的Buffer数据转为Json对象（与commandEscape合并使用）
  #### 参数(Buffer，设备返回的数据)
    #### 返回值：
    | 属性    | 说明 | 示例 
    | :-----| :----: | :----: | :----: | :----: | :----: |
    | initialInstruction |完整的指令码|AA4100060C00020008000101
    | prefix |错误标记、应答标记、版本号 |41
    | payloadLength |数据长度，即从 TL1 Header之后开始的数据|0006
    | sumCheck |TL1 Payload 段所有数据无进位累加和|0C
    | sequenceID |发送时持续累加|00
    | command |设置命令|02
    | keyPlaceholder |保留字段|00
    | key |key指令|08
    | valueLength |value包含的数据大小|0001
    | value |参数值|01
    | other |剩下的指令|
- ### commandEscape
    #### 说明：设置及读取跳绳的指令转义,将commandAnalysis解析后的Json数据转为可直接查看的Json
    #### 参数(Json，commandAnalysis解析后的Json数据)
    #### 返回值：
    | 属性    | 说明 | 示例 
    | :-----| :----: | :----: | :----: | :----: | :----: |
    | initialInstruction |完整的指令码|AA4100060C00020008000101
    | prefix |错误标记、应答标记、版本号 |41
    | payloadLength |数据长度，即从 TL1 Header之后开始的数据|0006
    | sumCheck |TL1 Payload 段所有数据无进位累加和|0C
    | sequenceID |发送时持续累加|00
    | command |设置命令|02
    | keyPlaceholder |保留字段|00
    | key |key指令|08
    | valueLength |value包含的数据大小|0001
    | value |参数值|01
    | other |剩下的指令|
    | responseCommand |转义之后的Object对象，根据command和key的不同，返回值不同|{year: 2022,month: 1,day: 4,...}

     ##### responseCommand对象,根据command和key）：
     
     > 读取设备固件版本号 command:02  key:01
        
        | 属性 | 类型  | 说明 | 示例 
        | :-----| :----: | :----: | :----: | :----: | :----: |
        | version |String|设备返回当前软件版本号，类型为字符串|23248216
        
    > 读取设备RTC时间 command:02  key:04
        
        | 属性 | 类型  | 说明 | 示例 
        | :-----| :----: | :----: | :----: | :----: | :----: |
        | year |String|年|2022
        | month |String|月|01
        | day |String|日|02
        | hour |String|时|09
        | minute |String|分|08
        | second |String|秒|58
        | dateTime |String|日期|2022-01-02 09:08:58
        
    > 读取设备电量 command:02  key:05
        
        | 属性 | 类型  | 说明 | 示例 
        | :-----| :----: | :----: | :----: | :----: | :----: |
        | battery |Int|电量（%）|66
        
    > 读取设备当前跳绳状态 command:02  key:07
        
        | 属性 | 类型  | 说明 | 示例 
        | :-----| :----: | :----: | :----: | :----: | :----: |
        | version |Int|版本（指令版本）|1
        | mode |Int|跳绳模式：1-自由跳2-倒计时跳3-倒计数跳|1
        | status |Int|跳绳设备的状态|1
        | modeValue |Int|跳绳模式设置的值）|99
        | number |Int|跳绳次数|100
        | activeMs |Int|有效跳绳时长|68
        | duraMs |Int|当前时间显示|99
        | doubleJump |Int|双摇次数|1
        | tripleJump |Int|三摇次数|1
        
    > 获取鉴权随机码 command:02  key:08
        
        | 属性 | 类型  | 说明 | 示例 
        | :-----| :----: | :----: | :----: | :----: | :----: |
        | random |Int|随机码|668899
        
    > 获取客户码 command:02  key:09
        
        | 属性 | 类型  | 说明 | 示例 
        | :-----| :----: | :----: | :----: | :----: | :----: |
        | customerCode |Int|随机码|668899
    
    > 获取双三摇开关 command:02  key:0A
        
        | 属性 | 类型  | 说明 | 示例 
        | :-----| :----: | :----: | :----: | :----: | :----: |
        | tripleJumpSwitch |Int|开关状态（1开 0闭）|1
        
    > 获取功能配置项 command:02  key:0B
    
    | 属性 | 类型  | 说明 | 示例 
        | :-----| :----: | :----: | :----: | :----: | :----: |
        | tripleJumpSwitch |Int|开关状态（1开 0闭）|1
        | countSwitch |Int|开关状态（1开 0闭）|1
    
```
* 从手柄读取手柄目前支持的功能项 0101000000
* 版本号为1时，表示功能配置项有支持双三摇功能，仅解析第二个字节的第一位即可,为1时表示支持双三摇功能，可对其进行开启和关闭该功能。其他配置项版本号预留。
* 版本号为2时，表示功能配置项有是否支持双三摇功能、是否开关计数功能。解析时，第二字节1位为1时表示支持双三摇功能；第二字节2位为1时表示支持开关计数功能，这个是发光跳绳的需求，特殊场景下，用户可能需要关闭计数功能（比如使用了计数手柄跳发光跳绳，不希望两个设备都有历史数据)。其他配置项预留。
                                
```
> 获取发光跳绳相关信息  command:02  key:0C
        
    | 属性 | 类型  | 说明 | 示例 
    | :-----| :----: | :----: | :----: | :----: | :----: |
    | lightMode |Int|发光模式：1：单色常亮2：单色呼吸 3：多色渐变 4：BPM模式|1
    | brightness |Int|频次：1慢，2正常，3快|1
    | rate |Int|频次|1
    | colorList |Array|颜色数组:发光模式1和2，只跟3个字节分别是RGB。模式3至少是2个RGB，最多7个RGB。|[255,255,2,...]
        
    

- ### realTimeDataAnalysis
    #### 说明：实时跳绳数据指令解析
    #### 参数(Buffer)
    #### 返回值：
        | 属性 | 类型  | 说明 | 示例 
        | :-----| :----: | :----: | :----: | :----: | :----: |
        | mode |Int|跳绳模式：1-自由跳2-倒计时跳3-倒计数跳|2|1
        | status |Int|跳绳当前状态0.5(1-就绪状态 2-正在跳绳状态 5-跳绳结束状态)|2
        | modeValue |Int|模式值|99
        | count |Int|跳绳次数|788
        | activeMs |Int|有效跳绳时长|99
        | showTime |Int|当前时间显示|98
        | doubleJump |Int|双摇次数|0
        | tripleJump |Int|三摇次数|0


